"use strict";(self.webpackChunkdanielrive_site=self.webpackChunkdanielrive_site||[]).push([[8155],{2409:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=n(4848),s=n(8453);const r={slug:"terraform-gitops",title:"Using Terraform to push files to Git Repo for GitOps",authors:["danielrivera"],tags:["aws","SmartCash-Project","kubernetes"]},i=void 0,o={permalink:"/blog/terraform-gitops",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-07-11-Using-Terraform-to-push-files-to-Git-Repo-for-GitOps.md",source:"@site/blog/2024-07-11-Using-Terraform-to-push-files-to-Git-Repo-for-GitOps.md",title:"Using Terraform to push files to Git Repo for GitOps",description:"In this article, I will share my thoughts about using Terraform in the GitOps process, specifically to create the manifest and push it to the Git repo.",date:"2024-07-11T00:00:00.000Z",tags:[{inline:!1,label:"AWS",permalink:"/blog/tags/aws",description:"Content related with AWS"},{inline:!0,label:"SmartCash-Project",permalink:"/blog/tags/smart-cash-project"},{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes",description:"Content related with Kubernetes"}],readingTime:2.935,hasTruncateMarker:!0,authors:[{name:"Daniel German Rivera",title:"Cloud Engineer",url:"https://github.com/danielrive",page:{permalink:"/blog/authors/danielrivera"},socials:{github:"https://github.com/danielrive",linkedin:"https://www.linkedin.com/in/danielrive/"},key:"danielrivera"}],frontMatter:{slug:"terraform-gitops",title:"Using Terraform to push files to Git Repo for GitOps",authors:["danielrivera"],tags:["aws","SmartCash-Project","kubernetes"]},unlisted:!1,prevItem:{title:"Configuring Logging in AWS EKS Using Fluent Bit and CloudWatch",permalink:"/blog/eks-fluentbit"},nextItem:{title:"Adding monitoring to EKS using Prometheus operator",permalink:"/blog/EKS-Prometheus"}},l={authorsImageUrls:[void 0]},c=[{value:"The basics",id:"the-basics",level:2},{value:"Setting up the scenario",id:"setting-up-the-scenario",level:2},{value:"Creating the YAML files",id:"creating-the-yaml-files",level:2},{value:"Pros",id:"pros",level:2}];function h(e){const t={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"In this article, I will share my thoughts about using Terraform in the GitOps process, specifically to create the manifest and push it to the Git repo."}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/chouc9wyoln2u16pvejf.png",alt:"simple image"})}),"\n",(0,a.jsx)(t.h2,{id:"the-basics",children:"The basics"}),"\n",(0,a.jsx)(t.p,{children:"GitOps relies on a Git repository as the single source of truth. New commits imply infrastructure and application updates."}),"\n",(0,a.jsx)(t.p,{children:'Imagine a Git repository where you push all the manifests of the Kubernetes resources you want to create in your cluster. These are pulled by a tool or script that runs a "kubectl apply", creates the resources, and checks the Git repo for new changes to apply. This, at a high level, is GitOps.'}),"\n",(0,a.jsx)(t.h2,{id:"setting-up-the-scenario",children:"Setting up the scenario"}),"\n",(0,a.jsx)(t.p,{children:"For this case, the K8 cluster will run in AWS EKS, and Terraform is being used as an IaC tool."}),"\n",(0,a.jsxs)(t.p,{children:["A basic cluster can be created using Terraform. You can check an example ",(0,a.jsx)(t.a,{href:"https://github.com/danielrive/smart-cash/blob/main/infra/terraform/modules/eks/main.tf",children:"here"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["FluxCD installation can be done using ",(0,a.jsx)(t.a,{href:"https://fluxcd.io/flux/installation/bootstrap/github/",children:"the official documentation"})," or you can check ",(0,a.jsx)(t.a,{href:"https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep",children:"this"}),"."]}),"\n",(0,a.jsx)(t.p,{children:"I will not explain some Flux concepts like sources and Kustomizations; you can check that in the links shared previously."}),"\n",(0,a.jsx)(t.h2,{id:"creating-the-yaml-files",children:"Creating the YAML files"}),"\n",(0,a.jsx)(t.p,{children:"Let's say that we want to create a namespace for the development environment, we can use the following YAML:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-YAML",children:"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: develop\n  labels:\n    test: true\n"})}),"\n",(0,a.jsx)(t.p,{children:"We can push this file to GitHub and wait for FluxCD to do the magic."}),"\n",(0,a.jsx)(t.p,{children:"Now let's say that we want to create a service account and associate it with an AWS IAM role, the YAML can be:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-YAML",children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: sa-test-develop\n  annotations:  \n    eks.amazonaws.com/role-arn: arn:aws:iam::12345678910:role/TEST\n"})}),"\n",(0,a.jsx)(t.p,{children:"This looks easy but what happens if we have multiple environments or if We don't yet know the ARN of the role because this is part of our IaC?"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l8cmmw835be29z1fak2.png",alt:"help-me"})}),"\n",(0,a.jsx)(t.p,{children:"Here is where Terraform gives us a hand."}),"\n",(0,a.jsx)(t.p,{children:"You can create something like a template for the manifest and some variables that you can specify with Terraform. The two manifests would look like:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-YAML",children:"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: ENVIRONMENT\n  labels:\n    test: true\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-YAML",children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: sa-test-ENVIRONMENT\n  annotations:  \n    eks.amazonaws.com/role-arn: ROLE_ARN\n"})}),"\n",(0,a.jsx)(t.p,{children:"Notice the ENVIRONMENT and ROLE_ARN variables added."}),"\n",(0,a.jsxs)(t.p,{children:["We can use the ",(0,a.jsx)(t.a,{href:"https://registry.terraform.io/providers/integrations/github/latest/docs",children:"Terraform GitHub provider"})," to push the file to the repository. Let's check the following code to push the service account:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-terraform",children:'resource "github_repository_file" "sa-test" {\n  repository          = data.github_repository.flux-gitops.name\n  branch              = main\n  file                = "./manifest/sa-manifest.yaml"\n  content = templatefile(\n    "sa-manifest.yaml",\n    {\n      ENVIRONMENT = var.environment\n      ROLE_ARN = aws_iam_role.arn\n    }\n  )\n  commit_message      = "Terraform"\n  commit_author       = "terraform"\n  commit_email        = "example@example"\n  overwrite_on_create = true\n}\n'})}),"\n",(0,a.jsxs)(t.p,{children:["The arguments ",(0,a.jsx)(t.strong,{children:"repository"})," and ",(0,a.jsx)(t.strong,{children:"branch"})," allow us to specify the remote repo and the branch where we want to push the file. The ",(0,a.jsx)(t.strong,{children:"file"})," argument is the location ",(0,a.jsx)(t.strong,{children:"in the remote repository"})," where we want to put the file."]}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.strong,{children:"content"})," argument is where we pass the values to the variables created in the template, in this case ENVIRONMENT and ROLE_ARN, the values are a terraform variable and the reference to a Terraform resource that creates the role."]}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.strong,{children:"overwrite_on_create"})," argument is needed because if you run Terraform again, it will show an error because the file already exists in the repo."]}),"\n",(0,a.jsx)(t.h2,{id:"pros",children:"Pros"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsx)(t.li,{children:"Pushing the manifests using Terraform avoids the manual tasks of committing and pushing them, allowing us to automate more steps."}),"\n",(0,a.jsx)(t.li,{children:"We can integrate this process into our pipeline, so a full environment can be ready when the pipeline finishes."}),"\n",(0,a.jsx)(t.li,{children:"Terraform count can be used when there are many manifests to push, avoiding repetitive code."}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var a=n(6540);const s={},r=a.createContext(s);function i(e){const t=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(r.Provider,{value:t},e.children)}}}]);