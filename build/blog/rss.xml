<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Daniel Rivera Blog</title>
        <link>https://danielrive-site.github.io/blog</link>
        <description>Daniel Rivera Blog</description>
        <lastBuildDate>Fri, 11 Oct 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Configuring Logging in AWS EKS Using Fluent Bit and CloudWatch]]></title>
            <link>https://danielrive-site.github.io/blog/eks-fluentbit</link>
            <guid>https://danielrive-site.github.io/blog/eks-fluentbit</guid>
            <pubDate>Fri, 11 Oct 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[fluent-bit]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" alt="fluent-bit" src="https://danielrive-site.github.io/assets/images/fluent-bit-logo-995cb8446c870684693ead3ced70e0d5.png" width="1000" height="420" class="img_ev3q"></p>
<p>Observability is essential for any application, and the Smart-cash project is no exception. Previously <a href="https://dev.to/aws-builders/adding-monitoring-to-eks-using-prometheus-operator-3ke1" target="_blank" rel="noopener noreferrer">Prometheus</a> was integrated for monitoring.</p>
<p>This article is part of a personal project called Smart-cash. Previous posts covered the deployment of <a href="https://dev.to/aws-builders/smartcash-project-infrastructure-terraform-and-github-actions-2bo3" target="_blank" rel="noopener noreferrer">AWS and Kubernetes resources</a> and <a href="https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep" target="_blank" rel="noopener noreferrer">how to install FluxCD</a> to implement GitOps practices.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-source-code">Project Source Code<a href="https://danielrive-site.github.io/blog/eks-fluentbit#project-source-code" class="hash-link" aria-label="Direct link to Project Source Code" title="Direct link to Project Source Code">​</a></h2>
<p>The full project code can be found <a href="https://github.com/danielrive/smart-cash/tree/develop" target="_blank" rel="noopener noreferrer">here</a>, the project is still under development but you can find the terraform code to create AWS resources and also the Kubernetes manifest.</p>
<p>In this <a href="https://github.com/danielrive/blog-posts/tree/main/Logging-EKS-FluentBit-CloudWatch" target="_blank" rel="noopener noreferrer">link</a> you can find the files used in this post</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="option-1-export-logs-directly-to-cloudwatch-logsno-cloudwatch-add-on">Option 1. Export logs directly to Cloudwatch Logs(No Cloudwatch add-on)<a href="https://danielrive-site.github.io/blog/eks-fluentbit#option-1-export-logs-directly-to-cloudwatch-logsno-cloudwatch-add-on" class="hash-link" aria-label="Direct link to Option 1. Export logs directly to Cloudwatch Logs(No Cloudwatch add-on)" title="Direct link to Option 1. Export logs directly to Cloudwatch Logs(No Cloudwatch add-on)">​</a></h2>
<p>The simplest configuration involves using Fluent-Bit's Tail Input, which reads the logs in the host <strong><em>/var/log/containers/*.log</em></strong> and sends them to Cloudwatch. This approach could be enough if you want to centralize the logs in CloudWatch or maybe another platform.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fluent-bit-installation">Fluent-Bit installation<a href="https://danielrive-site.github.io/blog/eks-fluentbit#fluent-bit-installation" class="hash-link" aria-label="Direct link to Fluent-Bit installation" title="Direct link to Fluent-Bit installation">​</a></h3>
<p>The Fluent-Bit Helm chart will be used in combination with FluxCD.</p>
<p>Adding the FluxCD source:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//fluent.github.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="adding-the-helm-chart">Adding the Helm chart<a href="https://danielrive-site.github.io/blog/eks-fluentbit#adding-the-helm-chart" class="hash-link" aria-label="Direct link to Adding the Helm chart" title="Direct link to Adding the Helm chart">​</a></h4>
<p>The supported values for the Fluent-Bit Helm chart can be found <a href="https://github.com/fluent/helm-charts/blob/main/charts/fluent-bit/values.yaml" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>To use Fluent Bit with AWS, the following requirements must be met:</p>
<ul>
<li><strong>IAM Roles for Service Accounts (IRSA)</strong>: You must set up an IAM role with permissions to create CloudWatch Logs streams and write logs. This role should be associated with the service account that Fluent Bit uses. AWS EKS Pod identity is also an option.</li>
<li><strong>CloudWatch Log Group</strong>: You can either create the CloudWatch Log group in advance or allow Fluent Bit to handle the log group creation.</li>
</ul>
<p>The main configuration is shown below (some lines have been omitted for brevity). The full configuration file can be found <a href="https://github.com/danielrive/blog-posts/tree/main/Logging-EKS-FluentBit-CloudWatch" target="_blank" rel="noopener noreferrer">link</a></p>
<p>Fluent-Bit will run as a DaemonSet. The Helm chart will create the RBAC and the Service account, named fluent-bit, which will be annotated with the AWS IAM role with the appropriate CloudWatch permissions.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm.toolkit.fluxcd.io/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">###ommited-lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.47.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">###ommited-lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">###ommited-lines</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serviceAccount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">create</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">aws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">iam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ACCOUNT_NUMBER</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">role/role</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ENVIRONMENT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rbac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">create</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">###ommited-lines</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A volume is needed for Filesystem buffering, which helps to manage <a href="https://docs.fluentbit.io/manual/administration/buffering-and-storage#filesystem-buffering-to-the-rescue" target="_blank" rel="noopener noreferrer">backpressure and overall memory control</a>, also this is used to store the position (or offsets) of the log files being read, allowing Fluent Bit to track its progress and resume from the correct position if needed.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">extraVolumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentbit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit/state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">extraVolumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentbit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit/state</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Configs section defines the <a href="https://docs.fluentbit.io/manual/pipeline/inputs" target="_blank" rel="noopener noreferrer">Inputs</a>, <a href="https://docs.fluentbit.io/manual/pipeline/filters" target="_blank" rel="noopener noreferrer">Filters</a>, and <a href="https://docs.fluentbit.io/manual/pipeline/outputs" target="_blank" rel="noopener noreferrer">Outputs</a> for collecting and processing data. For this scenario an Input of Tail type is configured to read the content of the files located at <strong><em>/var/log/containers/*.log</em></strong>. Let's break down the configuration details:</p>
<p><strong>Note:</strong> AWS has some advanced configurations for inputs, filters and output, you can check this <a href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/main/k8s-quickstart/cwagent-operator-rendered.yaml" target="_blank" rel="noopener noreferrer">link</a></p>
<p>The service section defines the global properties for Fluent-Bit, for this case:</p>
<ul>
<li>
<p><strong>Flush Interval</strong>: Set to 1 second, meaning Fluent Bit will send the collected logs to the configured output destinations every second.</p>
</li>
<li>
<p><strong>Log Level</strong>: Set to Info, which includes informational messages as well as warnings and errors.</p>
</li>
<li>
<p>The storage path for Filesystem buffering is the volume mounted in previous configurations with a backlog memory limit of 5M, which means that if Fluent-bit service reaches this limit, it stops loading any more backlog chunks from the storage path into memory.</p>
</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    [SERVICE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Daemon Off</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Flush  1</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Log_Level  info</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Parsers_File /fluent-bit/etc/parsers.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Parsers_File /fluent-bit/etc/conf/custom_parsers.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      HTTP_Server On</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      HTTP_Listen 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      HTTP_Port  \{\{ .Values.metricsPort \}\}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Health_Check On</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      storage.path  /var/fluent-bit/state/flb-storage/</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      storage.sync              normal</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      storage.checksum          off</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      storage.backlog.mem_limit 5M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Inputs define the data sources that Fluent Bit will collect logs from. In this scenario, the Tail input is used, which allows Fluent Bit to monitor one or more text files. Key points for this configuration include:</p>
<ul>
<li>In common Kubernetes environments, container runtimes store logs in the <strong><em>/var/log/pod/</em></strong> and <strong><em>/var/log/containers/</em></strong> (containers directory has symlinks to pod directory). Each log file follows a naming convention that includes key information like the pod name, namespace, container name, and container ID, for this case entries for fluent-bit, cloudwath-agent,kube-proxy, and aws-node will be ignored</li>
<li>Some log entries may span multiple lines. Fluent Bit handles multi-line logs with built-in modes, and for this scenario, the Docker or CRI modes are used to process them correctly.</li>
<li>To track the last line read from each log file, Fluent Bit uses a database to store this position. The database is saved in the previously mounted volume, ensuring that Fluent Bit can resume reading from the correct location.</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INPUT</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Name                tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tag                 applications.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Exclude_Path        /var/log/containers/cloudwatch</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /var/log/containers/fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /var/log/containers/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /var/log/containers/kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">proxy*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Path                /var/log/containers/</span><span class="token important">*.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   multiline.parser    docker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   DB                  /var/fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit/state/flb_container.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Mem_Buf_Limit       50MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Skip_Long_Lines     On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Refresh_Interval    10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   storage.type        filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Rotate_Wait         30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Outputs define where the collected data is sent, and Fluent-Bit provides a plugin to send logs to CloudWatch.</p>
<ul>
<li>If you check the Input configurations there is a tag defined, <strong><em>applications.*</em></strong>. this helps to assign a label to the logs collected for that Input, in this case, it ensures that logs with this tag are routed to the specified output destination.</li>
<li>CloudWatch log groups can be created by Fluent Bit, but in this scenario, the creation is disabled (set to off) since Terraform is used to manage log groups.</li>
<li>The <strong><em>log_stream_prefix</em></strong> sets a prefix for the log streams created in CloudWatch, helping organize and identify the log entries within the stream.</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OUTPUT</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Name cloudwatch_logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Match applications.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   region $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">AWS_REGION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   log_group_name /aws/eks/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CLUSTER_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   log_stream_prefix from</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   auto_create_group off</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you deploy the Helm chart you can check the CloudWatch service, if everything is working you should see some stream created, in this case out prefix is from-k8-fluent-bit-</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mtyh8dejch7iqqsbbnj5.png" alt="Log-Stream" class="img_ev3q"></p>
<p>and the log entry</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/azg2f14qnolys0nfb687.png" alt="log-entry" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="adding-a-filter">Adding a filter<a href="https://danielrive-site.github.io/blog/eks-fluentbit#adding-a-filter" class="hash-link" aria-label="Direct link to Adding a filter" title="Direct link to Adding a filter">​</a></h4>
<p>Filters in Fluent Bit allow you to enrich the data being collected. For instance, the Kubernetes Filter adds valuable metadata to log entries, such as namespace, pod_name, host, and more.</p>
<p>Here are some key points about the filter configuration:</p>
<ul>
<li>
<p>The Tag from the input configuration is reused here to extract information like pod_name, namespace, and other relevant metadata.</p>
</li>
<li>
<p>The Kube_URL points to the Kubernetes API server, which Fluent Bit queries to obtain metadata about the pods involved in the logs. The path for the token and certificate is specified in Kube_CA_File and Kube_Token_File.</p>
</li>
<li>
<p>You can configure the filter to include annotations and labels from the pods in the log entries.</p>
</li>
</ul>
<p><strong>Note:</strong> Be cautious about Fluent Bit querying the API server for metadata. In clusters with a high number of resources, <a href="https://aws.amazon.com/blogs/containers/capturing-logs-at-scale-with-fluent-bit-and-amazon-eks/" target="_blank" rel="noopener noreferrer">this can put an additional</a> load on the API server. <a href="https://aws.amazon.com/blogs/containers/capturing-logs-at-scale-with-fluent-bit-and-amazon-eks/" target="_blank" rel="noopener noreferrer">One optimization</a> is to retrieve pod metadata from the node’s kubelet instead of the kube-apiserver, but this requires enabling hostNetwork in the DaemonSet</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">FILTER</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Name   kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Match  applications.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Kube_URL      https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//kubernetes.default.svc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Kube_CA_File       /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Kube_Token_File </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Kube_Tag_Prefix     application.var.log.containers.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Merge_Log           On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Merge_Log_Key       log_processed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   K8S</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Logging.Parser  On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   K8S</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Logging.Exclude Off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Labels              On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Annotations         Off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Buffer_Size         0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After applying this filter the logs should have pods metadata</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3pb61s2hu5gbth72m4xy.png" alt="after-filter" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="option-2-use-the-amazon-cloudwatch-observability-add-on">Option 2. Use the amazon-cloudwatch-observability add-on<a href="https://danielrive-site.github.io/blog/eks-fluentbit#option-2-use-the-amazon-cloudwatch-observability-add-on" class="hash-link" aria-label="Direct link to Option 2. Use the amazon-cloudwatch-observability add-on" title="Direct link to Option 2. Use the amazon-cloudwatch-observability add-on">​</a></h2>
<p>Container Insights can be used to collect, aggregate, and summarize both metrics and logs. If you plan to enable this in your EKS cluster, the Amazon CloudWatch Observability add-on installs the necessary resources to achieve this.</p>
<p>At a high level, the add-on installs two key components:</p>
<ul>
<li>A CloudWatch agent to collect metrics.</li>
<li>Fluent-Bit to collect logs, using the <a href="https://github.com/aws/aws-for-fluent-bit" target="_blank" rel="noopener noreferrer">AWS for Fluent-bit container image</a>.</li>
</ul>
<p>Both components are deployed as DaemonSets.</p>
<p>The add-on can be installed via Terraform or by using a <a href="https://github.com/aws-observability/helm-charts/blob/main/charts/amazon-cloudwatch-observability/values.yaml" target="_blank" rel="noopener noreferrer">Helm-chart</a>, Regardless of the method, you'll need to create an IAM role for the service account <strong><em>cloudwatch-agent</em></strong> in the <strong><em>amazon-cloudwatch</em></strong> namespace.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_eks_addon" "cloudwatch" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_name                = aws_eks_cluster.kube_cluster.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addon_name                  = "amazon-cloudwatch-observability"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addon_version               = ""v2.1.2-eksbuild.1""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_account_role_arn    = aws_iam_role.cloudwatch_role.arn </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resolve_conflicts_on_update = "OVERWRITE"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The add-on creates several resources in the cluster, some of which you may not need. For example, if you list the DaemonSets in the amazon-cloudwatch namespace, you'll notice seven DaemonSets, some of which might have 0 replicas. While these resources may not be actively used, they still exist in your cluster and can create some noise.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1oxdmpgpr12lfg4q4xk8.png" alt="addon-installed" class="img_ev3q"></p>
<p>You can customize the add-on configurations to suit your needs. For example, you can disable Fluent Bit logs for Accelerated Compute monitoring or skip collecting NVIDIA GPU metrics.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_eks_addon" "cloudwatch" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_name                = aws_eks_cluster.kube_cluster.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addon_name                  = "amazon-cloudwatch-observability"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addon_version               = ""v2.1.2-eksbuild.1""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_account_role_arn    = aws_iam_role.cloudwatch_role.arn </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resolve_conflicts_on_update = "OVERWRITE"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configuration_values = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerLogs = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logs = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          metrics_collected = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            application_signals = {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kubernetes = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "enhanced_container_insights": true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "accelerated_compute_metrics": false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }}}}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By default, the add-on creates four CloudWatch log groups. The following image, taken from the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html#Container-Insights-FluentBit-setup" target="_blank" rel="noopener noreferrer">AWS documentation</a>, explains the naming structure of the log groups and the type of data each group stores.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/yzv79wm5xrnu9rozjf96.png" alt="AWS-Logs-group" class="img_ev3q"></p>
<p>To change expiration days and names for the groups is better to use the Helm chart instead of the Terraform code to install the add-on. You can do this by modifying the fluent-bit outputs.</p>
<p>The last log group is named performance and stores metrics collected by the CloudWatch agent, such as the number of running pods, CPU usage, and memory metrics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bonus-cluster-dashboard">Bonus: Cluster dashboard<a href="https://danielrive-site.github.io/blog/eks-fluentbit#bonus-cluster-dashboard" class="hash-link" aria-label="Direct link to Bonus: Cluster dashboard" title="Direct link to Bonus: Cluster dashboard">​</a></h3>
<p>As mentioned earlier, the CloudWatch add-on collects, aggregates, and summarizes metrics. Once the add-on is installed, AWS automatically generates a dashboard that provides useful insights and metrics for your cluster.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z8nhm4tzefmu4w1shgvr.png" alt="Cluster-dashboard" class="img_ev3q"></p>
<p>You can watch metric per pod</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ttwtfahdt2htcy5yh4ok.png" alt="metric-per-pod" class="img_ev3q"></p>
<p>It also generates a visual map that organizes Kubernetes resources by namespace.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ro4q55u98jm2pbkk8r7u.png" alt="Cluster-resource-mapping" class="img_ev3q"></p>]]></content:encoded>
            <category>AWS</category>
            <category>SmartCash-Project</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[Using Terraform to push files to Git Repo for GitOps]]></title>
            <link>https://danielrive-site.github.io/blog/terraform-gitops</link>
            <guid>https://danielrive-site.github.io/blog/terraform-gitops</guid>
            <pubDate>Thu, 11 Jul 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[In this article, I will share my thoughts about using Terraform in the GitOps process, specifically to create the manifest and push it to the Git repo.]]></description>
            <content:encoded><![CDATA[<p>In this article, I will share my thoughts about using Terraform in the GitOps process, specifically to create the manifest and push it to the Git repo.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/chouc9wyoln2u16pvejf.png" alt="simple image" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-basics">The basics<a href="https://danielrive-site.github.io/blog/terraform-gitops#the-basics" class="hash-link" aria-label="Direct link to The basics" title="Direct link to The basics">​</a></h2>
<p>GitOps relies on a Git repository as the single source of truth. New commits imply infrastructure and application updates.</p>
<p>Imagine a Git repository where you push all the manifests of the Kubernetes resources you want to create in your cluster. These are pulled by a tool or script that runs a "kubectl apply", creates the resources, and checks the Git repo for new changes to apply. This, at a high level, is GitOps.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-scenario">Setting up the scenario<a href="https://danielrive-site.github.io/blog/terraform-gitops#setting-up-the-scenario" class="hash-link" aria-label="Direct link to Setting up the scenario" title="Direct link to Setting up the scenario">​</a></h2>
<p>For this case, the K8 cluster will run in AWS EKS, and Terraform is being used as an IaC tool.</p>
<p>A basic cluster can be created using Terraform. You can check an example <a href="https://github.com/danielrive/smart-cash/blob/main/infra/terraform/modules/eks/main.tf" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>FluxCD installation can be done using <a href="https://fluxcd.io/flux/installation/bootstrap/github/" target="_blank" rel="noopener noreferrer">the official documentation</a> or you can check <a href="https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep" target="_blank" rel="noopener noreferrer">this</a>.</p>
<p>I will not explain some Flux concepts like sources and Kustomizations; you can check that in the links shared previously.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-yaml-files">Creating the YAML files<a href="https://danielrive-site.github.io/blog/terraform-gitops#creating-the-yaml-files" class="hash-link" aria-label="Direct link to Creating the YAML files" title="Direct link to Creating the YAML files">​</a></h2>
<p>Let's say that we want to create a namespace for the development environment, we can use the following YAML:</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can push this file to GitHub and wait for FluxCD to do the magic.</p>
<p>Now let's say that we want to create a service account and associate it with an AWS IAM role, the YAML can be:</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sa</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">aws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">iam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">12345678910</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">role/TEST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This looks easy but what happens if we have multiple environments or if We don't yet know the ARN of the role because this is part of our IaC?</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l8cmmw835be29z1fak2.png" alt="help-me" class="img_ev3q"></p>
<p>Here is where Terraform gives us a hand.</p>
<p>You can create something like a template for the manifest and some variables that you can specify with Terraform. The two manifests would look like:</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ENVIRONMENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sa</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ENVIRONMENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ROLE_ARN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice the ENVIRONMENT and ROLE_ARN variables added.</p>
<p>We can use the <a href="https://registry.terraform.io/providers/integrations/github/latest/docs" target="_blank" rel="noopener noreferrer">Terraform GitHub provider</a> to push the file to the repository. Let's check the following code to push the service account:</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "github_repository_file" "sa-test" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository          = data.github_repository.flux-gitops.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch              = main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file                = "./manifest/sa-manifest.yaml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content = templatefile(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "sa-manifest.yaml",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ENVIRONMENT = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ROLE_ARN = aws_iam_role.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commit_message      = "Terraform"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commit_author       = "terraform"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commit_email        = "example@example"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  overwrite_on_create = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The arguments <strong>repository</strong> and <strong>branch</strong> allow us to specify the remote repo and the branch where we want to push the file. The <strong>file</strong> argument is the location <strong>in the remote repository</strong> where we want to put the file.</p>
<p>The <strong>content</strong> argument is where we pass the values to the variables created in the template, in this case ENVIRONMENT and ROLE_ARN, the values are a terraform variable and the reference to a Terraform resource that creates the role.</p>
<p><strong>overwrite_on_create</strong> argument is needed because if you run Terraform again, it will show an error because the file already exists in the repo.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pros">Pros<a href="https://danielrive-site.github.io/blog/terraform-gitops#pros" class="hash-link" aria-label="Direct link to Pros" title="Direct link to Pros">​</a></h2>
<ol>
<li>Pushing the manifests using Terraform avoids the manual tasks of committing and pushing them, allowing us to automate more steps.</li>
<li>We can integrate this process into our pipeline, so a full environment can be ready when the pipeline finishes.</li>
<li>Terraform count can be used when there are many manifests to push, avoiding repetitive code.</li>
</ol>]]></content:encoded>
            <category>AWS</category>
            <category>SmartCash-Project</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[Adding monitoring to EKS using Prometheus operator]]></title>
            <link>https://danielrive-site.github.io/blog/EKS-Prometheus</link>
            <guid>https://danielrive-site.github.io/blog/EKS-Prometheus</guid>
            <pubDate>Thu, 30 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[eks+prometheus+grafana]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/404iotfmmlhlrsm8swt7.png" alt="eks+prometheus+grafana" class="img_ev3q"></p>
<p>Previous articles showed how to <a href="https://dev.to/aws-builders/smartcash-project-infrastructure-terraform-and-github-actions-2bo3" target="_blank" rel="noopener noreferrer">build the EKS Infrastructure in AWS</a> and <a href="https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep" target="_blank" rel="noopener noreferrer">how to install FluxCD</a> to implement GitOps practices, This article is focused on explaining the steps taken to install the Prometheus Operator(using Helm) and Grafana for monitoring.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code">Source Code<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#source-code" class="hash-link" aria-label="Direct link to Source Code" title="Direct link to Source Code">​</a></h2>
<p>The source code for this project can be found <a href="https://github.com/danielrive/smart-cash/releases/tag/v1.3.0" target="_blank" rel="noopener noreferrer">here</a>, also a <a href="https://github.com/danielrive/smart-cash-gitops-flux" target="_blank" rel="noopener noreferrer">GitOps repository</a> has been created to store the Yaml files that FluxCD uses and apply to the EKS cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus-operator">Prometheus operator<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#prometheus-operator" class="hash-link" aria-label="Direct link to Prometheus operator" title="Direct link to Prometheus operator">​</a></h2>
<blockquote>
<p>The Prometheus Operator provides Kubernetes native deployment and management of Prometheus and related monitoring components.</p>
</blockquote>
<p>The <a href="https://prometheus-operator.dev/docs/operator/design/" target="_blank" rel="noopener noreferrer">Prometheus operator</a> defines Kubernetes Custom Resources and controllers that facilitate installing Prometheus. The community has developed alternative options such as <em>kube-Prometheus</em> and <em>kube-prometheus-stack</em> to install the components to monitor Kubernetes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus-operator-kube-prometheus-and-kube-prometheus-stack">Prometheus Operator, kube-prometheus and kube-prometheus-stack<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#prometheus-operator-kube-prometheus-and-kube-prometheus-stack" class="hash-link" aria-label="Direct link to Prometheus Operator, kube-prometheus and kube-prometheus-stack" title="Direct link to Prometheus Operator, kube-prometheus and kube-prometheus-stack">​</a></h3>
<p>The project repository for Prometheus-operator can be found <a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noopener noreferrer">here</a>, The repo defines the CRDs and the controller. You can follow this <a href="https://prometheus-operator.dev/docs/user-guides/getting-started/" target="_blank" rel="noopener noreferrer">documentation</a> for the installation. which will require the creation of metrics exporters, node exporters, scrape configurations, etc.</p>
<p>On the other hand, the <a href="https://github.com/prometheus-operator/kube-prometheus" target="_blank" rel="noopener noreferrer">Kube-prometheus</a> project provides documentation and scripts to operate end-to-end Kubernetes cluster monitoring using the Prometheus Operator, making easier the process of monitoring the Kubernetes cluster.</p>
<p><a href="https://github.com/prometheus-community/helm-charts" target="_blank" rel="noopener noreferrer">kube-prometheus-stack</a> is a Helm chart that contains several components to monitor the Kubernetes cluster, along with Grafana dashboards to visualize the data. This option will be used in this article.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-kube-prometheus-stack-helm-chart">Installing kube-prometheus-stack Helm chart<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#installing-kube-prometheus-stack-helm-chart" class="hash-link" aria-label="Direct link to Installing kube-prometheus-stack Helm chart" title="Direct link to Installing kube-prometheus-stack Helm chart">​</a></h2>
<p>In previous articles, FluxCD was installed in EKS cluster to implement GitOps, the following flux source will now be added.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> source.toolkit.fluxcd.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">community.github.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Also, a Flux Helm release is added</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm.toolkit.fluxcd.io/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaultRules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kubeSchedulerAlerting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kubeSchedulerRecording</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">windows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">prometheusSpec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">storageSpec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">volumeClaimTemplate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">storageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ebs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gp2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"ReadWriteOnce"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 40Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you examine the values for the chart, by default, it installs rules to monitor etcd and some other control plane components. However, in this case, that is not necessary due to EKS limiting access to certain control-plane components.</p>
<p>By default, Prometheus uses local storage to store data. To enable persistent storage, an EBS volume can be added. In this scenario, the <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html" target="_blank" rel="noopener noreferrer">EBS CSI</a> driver is employed, and a storage class is defined to manage the integration with Prometheus.</p>
<p>Once the manifests are ready, you can push them to the GitOps repo( <a href="https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/helm-prometheus.yaml" target="_blank" rel="noopener noreferrer">here</a> for this case), and wait for Flux to handle the installation process in the cluster.</p>
<p>You can check the cluster by looking for the resources created, notice that for this case, everything will be placed in the <strong>monitoring</strong> namespace.</p>
<p><code>kubectl get crd</code></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qfjv7qgaitj5a0pmmsfc.png" alt="prometheus-cdr" class="img_ev3q"></p>
<p>Additionally, certain deployments and services should have been created in the monitoring namespace.</p>
<p><code>kubectl get pods -n monitoring</code></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6suj0e8ez0kf3jkn3vde.png" alt="pods" class="img_ev3q"></p>
<p>Let's look at the Prometheus server console, you can expose the service by an ingress or using port-forward.</p>
<p><code>kubectl port-forward service/prometheus-kube-prometheus-prometheus 3001:9090 -n monitoring</code></p>
<p>The previous command will expose the Prometheus service in localhost:3001, you can go directly to the targets and you should see some targets created automatically, as well as the metrics and the services discovered by the server.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z0a5ff0d9w9es56q4gtu.png" alt="targets" class="img_ev3q"></p>
<p>This is useful because you don't need to configure the targets to monitor K8 and node metrics, the Helm chart does this for you. For instance, a simple example is just to check the number of pods created in the default namespace, you can run this PromQL query.</p>
<p><code>count(kube_pod_created{namespace="default"})</code></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dwt7ryjpjyay53x2q9r7.png" alt="simple-query" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grafana-dashboards">Grafana Dashboards<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#grafana-dashboards" class="hash-link" aria-label="Direct link to Grafana Dashboards" title="Direct link to Grafana Dashboards">​</a></h3>
<p>Helm chart also installs Grafana and configures some useful dashboards that you can use, if you list the services and pods you will see some resources related to Grafana. You can expose the Grafana service or create an ingress for it.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-nginx-ingress-for-grafana">Creating nginx ingress for Grafana<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#creating-nginx-ingress-for-grafana" class="hash-link" aria-label="Direct link to Creating nginx ingress for Grafana" title="Direct link to Creating nginx ingress for Grafana">​</a></h4>
<p>Nginx-ingress is utilized and installed using Helm. You can add the following Flux source and the Helm release to the GitOps repo. Check the GitOps repo for this project <a href="https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/helm-nginx-ingress.yaml" target="_blank" rel="noopener noreferrer">here</a> and use it as a model.</p>
<p>Helm source</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> source.toolkit.fluxcd.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//ghcr.io/nginxinc/charts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Use this yaml to install the chart, in this case AWS Network Load Balancer is used, this is done through the annotation specified in the values for the chart.</p>
<div class="language-Yaml language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm.toolkit.fluxcd.io/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">controller</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nlb"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="installing-cert-managet-to-support-ssl">Installing Cert-managet to support SSL<a href="https://danielrive-site.github.io/blog/EKS-Prometheus#installing-cert-managet-to-support-ssl" class="hash-link" aria-label="Direct link to Installing Cert-managet to support SSL" title="Direct link to Installing Cert-managet to support SSL">​</a></h4>
<blockquote>
<p>This article will not dig into details about cert-manager concepts.</p>
</blockquote>
<p>In order to support SSL in the EKS cluster cert-manager will be used, cert-manager adds certificates and certificate issuers as resource types in Kubernetes clusters, and simplifies the process of obtaining, renewing and using those certificates.</p>
<p>Cert-manager uses Kubernetes CRD, to install them you can run:</p>
<p><code>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.crds.yaml</code></p>
<p>This also can be added to the GitOps repo(check <a href="https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/crd-cert-manager.yaml" target="_blank" rel="noopener noreferrer">here</a>) and given to Flux to handle it.</p>
<p>When the CRDs are ready, you can install cert-manager, in this case a Helm chart will be used, this also will be added in GitOps repo.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm.toolkit.fluxcd.io/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.13.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serviceAccount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">aws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">iam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">123456789</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">role/cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">us</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">west</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">extraArgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">issuer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ambient</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally and cert-manager ClusterIssuer is added, in this case the domain will be validated in AWS Route53, this is done through the IAM role passed in the previous YAML file for the Helm chart.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manager.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">letsencrypt2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">acme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">email</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> notreply@example.info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//acme</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">staging</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privateKeySecretRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">issuer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">solvers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">dnsZones</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"example.info"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">dns01</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">route53</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> us</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">west</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once cert-manager and nginx-ingress are installed you can create an ingress for Grafana. The following manifest has been added to the GitOps repo.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cert-manager.io/cluster-issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">letsencrypt2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ingressClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring.example.info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> monitoring.example.info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">secretName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">issuer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">key2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this installed you can browser and access Grafana, you should see some dashboards already created.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/cxhfnhv82jfuk3b1kj8t.png" alt="Grafana-dash" class="img_ev3q"></p>
<p>For instance, the <em>Kubernetes/API server</em> dashboard is pre-configured, also you can also use third-party dashboards.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7zilyb7s756tkm696r4g.png" alt="Grafana-k8-api" class="img_ev3q"></p>]]></content:encoded>
            <category>AWS</category>
            <category>SmartCash-Project</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[GitOps with FluxCD]]></title>
            <link>https://danielrive-site.github.io/blog/fluxcd</link>
            <guid>https://danielrive-site.github.io/blog/fluxcd</guid>
            <pubDate>Sat, 04 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[GitOps meme, source https://blog.kubesimplify.com/gitops-demystified]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t18cxoi3v9353gucvs2p.png" alt="GitOps meme, source https://blog.kubesimplify.com/gitops-demystified" class="img_ev3q"></p>
<p>In a <a href="https://dev.to/aws-builders/smartcash-project-infrastructure-terraform-and-github-actions-2bo3" target="_blank" rel="noopener noreferrer">previous article</a> I mentioned the idea behind this project that I named SmartCash. I began building the terraform code for the infrastructure in AWS and the pipeline to deploy it.</p>
<p>In this article, I will introduce FluxCD as a GitOps tool and demonstrate its usage.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code">Source code<a href="https://danielrive-site.github.io/blog/fluxcd#source-code" class="hash-link" aria-label="Direct link to Source code" title="Direct link to Source code">​</a></h2>
<p>A new release has been created in the smart-cash repository for the project. v1.1.0 version will be used, you can check the repository <a href="https://github.com/danielrive/smart-cash/tree/v1.1.0" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Additionally, a new repository will be created to store the K8 manifest that will be synced with the EKS cluster using FluxCD, you can view the repo <a href="https://github.com/danielrive/smart-cash-gitops-flux" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-quick-introduction-to-gitops">A quick introduction to GitOps<a href="https://danielrive-site.github.io/blog/fluxcd#a-quick-introduction-to-gitops" class="hash-link" aria-label="Direct link to A quick introduction to GitOps" title="Direct link to A quick introduction to GitOps">​</a></h2>
<p>GitOps is an operational model for cloud-native architectures,  it relies on a Git repository as the single source of truth. New commits imply infrastructure and application updates.</p>
<p>OpenGitOps group has defined 5 principles, and while I won't delve into them, <a href="https://opengitops.dev/" target="_blank" rel="noopener noreferrer">here</a>, you can read more. If you take a look at those principles you will see that they are, in some sense related to some Kubernetes concepts.</p>
<p>A great book to gain a better understanding of GitOps history and concepts is <strong><a href="https://developers.redhat.com/e-books/path-gitops" target="_blank" rel="noopener noreferrer">The Path to GitOps</a></strong>.</p>
<p>In summary, GitOps is centered around using a Git repository for defining and managing both infrastructure and application configurations through a Git-based workflow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-fluxcd">What is FluxCD<a href="https://danielrive-site.github.io/blog/fluxcd#what-is-fluxcd" class="hash-link" aria-label="Direct link to What is FluxCD" title="Direct link to What is FluxCD">​</a></h3>
<p><a href="https://fluxcd.io/" target="_blank" rel="noopener noreferrer">FluxCD</a> is an open-source GitOps operator for Kubernetes, you can declaratively define the desired state of your infrastructure and configurations in a Git repository. Flux monitors the repository and applies updates to the Kubernetes cluster when new changes arrive.</p>
<p>Flux started as a monolith but in v2 it was broken up into individual components called GitOps Toolkit, this refers collection of specialized tools, Flux Controllers, composable APIs, and reusable Go packages available under the fluxcd GitHub organization.</p>
<p>Core concepts and toolkit components are described <a href="https://www.weave.works/technologies/what-is-flux-cd/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/hv4kfhyq6yq90x3e27wh.png" alt="hands-on" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-fluxcd-in-the-cluster">Installing FluxCD in the cluster<a href="https://danielrive-site.github.io/blog/fluxcd#installing-fluxcd-in-the-cluster" class="hash-link" aria-label="Direct link to Installing FluxCD in the cluster" title="Direct link to Installing FluxCD in the cluster">​</a></h2>
<p>FluxCD <a href="https://fluxcd.io/flux/installation/" target="_blank" rel="noopener noreferrer">installation</a> can be done by Flux CLI, the most straightforward method can be done by the <a href="https://fluxcd.io/flux/installation/bootstrap/" target="_blank" rel="noopener noreferrer"><strong><em>flux bootstrap</em></strong> command</a>, this deploys the Flux controllers on the K8 cluster and configures them to synchronize the cluster to the Git repository, if the Git Repo doesn't exist, the bootstrap command will create it.</p>
<p>To incorporate FluxCD installation into this project a new bash script has been added into the repository that contains the terraform code, this bash script will be execute by terraform as a null resource.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Configure Cluster Credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># $1 = CLUSTER_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># $2 = AWS_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># $3 = GH_USER_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># $4 = FLUX_REPO_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo "----------&gt;  get eks credentials"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws eks update-kubeconfig --name $1  --region $2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## validate if flux is installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flux_installed=$(kubectl api-resources | grep flux)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -z "$flux_installed" ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo "----------&gt;  flux is not installed"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ### install flux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo "----------&gt;  installing flux cli"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  curl -s https://fluxcd.io/install.sh | sudo bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo "----------&gt;  run flux bootstrap"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flux bootstrap github \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --owner=$3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --repository=$4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --path="clusters/$1/bootstrap" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --branch=main \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --personal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo "----------&gt;  flux is installed"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <em>flux bootstrap github</em> command deploys the Flux controllers on the K8 cluster and configures the controllers to synchronize the Git repo with the cluster. This is done by some K8 manifests that are created and pushed to the repo in the path passed in the command.</p>
<p>It's worth noting that some env variables like FLUX_REPO_NAME, and GH_USER_NAME are used by the bash script, these variables are passed as an argument in the bash script execution.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-fluxcd-bootstrap-script-to-terraform-code">Adding FluxCD bootstrap script to terraform code<a href="https://danielrive-site.github.io/blog/fluxcd#adding-fluxcd-bootstrap-script-to-terraform-code" class="hash-link" aria-label="Direct link to Adding FluxCD bootstrap script to terraform code" title="Direct link to Adding FluxCD bootstrap script to terraform code">​</a></h3>
<p>The bash script will be executed in the GH workflow template created to deploy the infrastructure, the following job is added to the Workflow template.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#### bash script arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # $1 = CLUSTER_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # $2 = AWS_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # $3 = GH_USER_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # $4 = FLUX_REPO_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "null_resource" "bootstrap-flux" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on          = [module.eks_cluster]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provisioner "local-exec" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ./scripts/bootstrap-flux.sh ${local.cluster_name}  ${var.region} ${local.gh_username} ${data.github_repository.flux-gitops.name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  triggers = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster_oidc = module.eks_cluster.cluster_oidc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at   = module.eks_cluster.created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice that the <em>GITHUB_TOKEN</em> variable is passed directly in the Github job.</p>
<p>Once the workflow is ready you can push it to the repo and see how terraform will create all the infra and after EKS cluster creation will execute the bash script.</p>
<p>You can run <strong>flux check</strong> command locally to validate the status of the installation(you should have access to the cluster in your local env)</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/czt08fmy5h10p2gq0na3.png" alt="flux-check" class="img_ev3q"></p>
<p>If you take a look at the above image you will see that the Source Controller is deployed, <a href="https://fluxcd.io/flux/components/source/" target="_blank" rel="noopener noreferrer">Source Controller</a> enables seamless integration of various Git repositories with your Kubernetes cluster. Think of the Source Controller as an interface to connect with GitRepositories, OCIRepository, HelmRepository, and Bucket resources.</p>
<p><code>✔ source-controller: deployment ready</code></p>
<p>The bootstrap command will create a flux source and associate it to the repo passed in the command, to validate this you can list the git sources created and you will see the one, for now.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flux get sources git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kjtan9rnhp0qc9mb6l02.png" alt="Flux-git-source" class="img_ev3q"></p>
<p>and you can see the K8 CDRs created</p>
<p><code>kubectl get crds | grep flux</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="structuring-the-git-repository">Structuring the Git repository<a href="https://danielrive-site.github.io/blog/fluxcd#structuring-the-git-repository" class="hash-link" aria-label="Direct link to Structuring the Git repository" title="Direct link to Structuring the Git repository">​</a></h2>
<p>There are different strategies to structure the GitOps repository, for this scenario, a mono-repo strategy is used and <a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">kustomize</a> will be used to manage the K8 manifest for the application.</p>
<ul>
<li>
<p><strong>./clusters</strong>: contains all the cluster associated with the project, cluster for each environment or region should be placed here.</p>
</li>
<li>
<p><strong>./clusters/smart-cash-develop/bootstrap:</strong> Yaml files created by fluxcd installation, also there is a file name <strong>core-kustomization.yaml</strong> that points to a core folder that manages the manifests.</p>
</li>
<li>
<p><strong>./clusters/smart-cash-develop/core:</strong> Contains the main manifest for the project, manifest like FluxSources, and also kustomization files. Here will be placed the kustomization file for each microservice that will be created.</p>
</li>
<li>
<p><strong>./clusters/smart-cash-develop/core:</strong> Manifests that create common resources for the cluster like namespaces, ingress, storage-classes, etc.</p>
</li>
<li>
<p><strong>Manifests:</strong> This contains subfolders that contain the YAML files for each microservices.</p>
</li>
</ul>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── clusters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── smart-cash-develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |── bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |── ingress-namespace.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   └── namespaces.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |── core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |── common-kustomize.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   └── helm-cert-manager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            └── app1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |── base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |── kustomization.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   └── deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                └── overlays</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |── develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |   └── kustomization.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    └── production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        └── kustomization.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-resources-to-the-cluster">Adding resources to the cluster<a href="https://danielrive-site.github.io/blog/fluxcd#adding-resources-to-the-cluster" class="hash-link" aria-label="Direct link to Adding resources to the cluster" title="Direct link to Adding resources to the cluster">​</a></h2>
<p>Let's create a K8 namespace to be used for an nginx-ingress. The manifest for this can be placed in the <em>common</em> folder. A FluxCD Kustomization can be added to synchronize the contents of this folder with the K8 cluster.</p>
<p>The following is the Flux Kustomization that reconciles the Kubernetes manifests located at the path <em>./common</em> in the Git repository .</p>
<p><strong>Note:</strong> This file can be added in <em>clusters/smart-cash-develop</em> folder, FluxCD will automatically create the Kustomization resource because this path was specified in the bootstrap command, and Flux created a Kustomization to synchronize it.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kustomize.toolkit.fluxcd.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kustomization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> smartcash</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">targetNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"./kustomize"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prune</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>interval:</strong> The period at which the Kustomization is reconciled.</li>
<li><strong>sourceRef:</strong> refers to the Source object with the required Artifacts, in this case, our GitOps repository.</li>
<li><strong>prune:</strong>: When is true, if previously applied objects are missing from the current revision, these objects are deleted from the cluster</li>
</ul>
<p>Once you push the Yaml file to the GitOps repo, Flux will create the resources in the cluster. You can validate running:</p>
<p><code>kubectl get kustomization -n flux-system</code></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/s0aqez3paizw42s38imz.png" alt="common-kustomization" class="img_ev3q"></p>
<p>The previous steps have created the FluxCD Kustomization to sync the <em>common</em> folder with the cluster. Now, a Kustomize file needs to be added to specify which resource to create.</p>
<p>Don't confuse the <a href="https://fluxcd.io/flux/components/kustomize/kustomizations/#path" target="_blank" rel="noopener noreferrer">FluxCD Kustomization</a> file with the K8 configuration management <a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">Kustomize</a>. FluxCD will look for the Kustomize file in the <em>common</em> folder.</p>
<p>Let's create and push the following files in the <em>common</em> folder.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kustomize.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kustomization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ns</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can wait for the flux reconciliation or force it using the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flux reconcile kustomization smartcash-common</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the process was successful you should see the nginx-ingress namespace.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="https://danielrive-site.github.io/blog/fluxcd#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting">​</a></h3>
<p>To validate the status of the reconciliation you can use the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flux get kustomization smartcash-common</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For instance, a mistake in the name of the YAML files caused this error, which was visible in the output of the flux command.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2gdw0r19wyk1r285c7hz.png" alt="Flux-error" class="img_ev3q"></p>
<p>If you want more details you can check the K8 CDRs using:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe kustomization smartcash-common -n flux-system </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-helm-release-for-nginx-ingress">Creating a Helm release for nginx-ingress<a href="https://danielrive-site.github.io/blog/fluxcd#creating-a-helm-release-for-nginx-ingress" class="hash-link" aria-label="Direct link to Creating a Helm release for nginx-ingress" title="Direct link to Creating a Helm release for nginx-ingress">​</a></h2>
<p>The Flux Helm Controller will be used to install the ingress. <a href="https://fluxcd.io/flux/components/helm/" target="_blank" rel="noopener noreferrer">The Helm Controller</a> is a Kubernetes operator that enables the management of Helm chart releases.</p>
<p>A FluxCD source for Helm needs to be added. This can be accomplished by using the following manifest, which should be placed in <em>clusters/smart-cash-develop</em>.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> source.toolkit.fluxcd.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//ghcr.io/nginxinc/charts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This source fetches the Helm OCI repository oci://ghcr.io/nginxinc/charts every 5 minutes, and the artifact is stored and updated each time new updates are done to the repository.</p>
<p>After creating the Helm source, you can proceed to create the Helm release. This release specifies the chart to install in the cluster, with the chart being fetched from the source already created. The following manifest can be used.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm.toolkit.fluxcd.io/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRelease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.17.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HelmRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To delegate the creation of the HelmRelease task to flux, this file can be added to the common folder and in the Kustomize file as well.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kustomize.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kustomization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ns</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">helm.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After updating and pushing the files, you can validate the creation of the Helm Release and nginx-ingress resources.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flux get helmreleases </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">n nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ui87g1erg9j42rc1ost4.png" alt="Helm-releases" class="img_ev3q"></p>
<p>Up to this point, we've covered the second phase of this project. In the upcoming articles, you'll delve into the implementation of various other tools and continue building the project.</p>
<p>If you have any feedback or suggestions, please feel free to reach out to me on <a href="https://www.linkedin.com/in/danielrive/" target="_blank" rel="noopener noreferrer">LinkedIn</a>.</p>]]></content:encoded>
            <category>AWS</category>
            <category>SmartCash-Project</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[AWS Infrastructure Terraform and GitHub Actions]]></title>
            <link>https://danielrive-site.github.io/blog/github-actions</link>
            <guid>https://danielrive-site.github.io/blog/github-actions</guid>
            <pubDate>Wed, 25 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[gh-actions]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" alt="gh-actions" src="https://danielrive-site.github.io/assets/images/gh-actions-3531739acdde0650318b603c71dbeb2d.jpg" width="1024" height="524" class="img_ev3q"></p>
<p>The journey to learn a new tool can be a little tricky, watching videos and reading some blogs can be an option, but watching and reading can not be enough for everyone, personally I need a hands-on approach for effective learning.</p>
<p>That motivation drove me to embark on a personal project where I could implement the tools I had been using and those I wanted to explore. to initiate this journey I decided to create an application that helped me to follow my expenses, it could be something trivial but I needed a "business case" to begin building a solution.</p>
<p>The general idea is to have an application that helps you track the monthly expenses and filter for a particular category to see where the money is going.</p>
<p>Let's start building the initial infrastructure needed for the application.</p>
<p><a href="https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep" target="_blank" rel="noopener noreferrer">Here</a> you can find the GitOps implementation(Part 2 of the project).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="source-code">Source Code<a href="https://danielrive-site.github.io/blog/github-actions#source-code" class="hash-link" aria-label="Direct link to Source Code" title="Direct link to Source Code">​</a></h3>
<p>The version of the code used in this article can be found <a href="https://github.com/danielrive/smart-cash/releases/tag/v1.0.0" target="_blank" rel="noopener noreferrer">here</a>. only specific sections of the code are included here to provide explanations, as this approach avoids the need to paste the entire code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="https://danielrive-site.github.io/blog/github-actions#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h3>
<p>The image below shows the first version of the architecture to use, I chose Kubernetes for this project as it allows me to explore some tools for K8 and improve some skills to present a K8 certification.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1b6f3mgm9voy16u0lp8.jpeg" alt="Diagram Arch v1" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="iac">IaC<a href="https://danielrive-site.github.io/blog/github-actions#iac" class="hash-link" aria-label="Direct link to IaC" title="Direct link to IaC">​</a></h3>
<p>Terraform is the tool for IaC, while I won't delve into a detailed terraform code explanation, I will provide some key highlights:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="networking">Networking<a href="https://danielrive-site.github.io/blog/github-actions#networking" class="hash-link" aria-label="Direct link to Networking" title="Direct link to Networking">​</a></h4>
<p>A <a href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest" target="_blank" rel="noopener noreferrer">third-party</a> TF module is used. to save some aws costs the NAT gateways have been disabled.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="eks">EKS<a href="https://danielrive-site.github.io/blog/github-actions#eks" class="hash-link" aria-label="Direct link to EKS" title="Direct link to EKS">​</a></h4>
<p>A TF module has been developed to deploy the resources needed for an EKS cluster. I created manually an IAM user and passed it as a variable(<em>var.userRoleARN</em>) to the EKS module. This internally runs an <em>eksctl</em> command to add it to the RBAC configs. This user will be used to operate the cluster locally.</p>
<div class="language-Terraform language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "null_resource" "iam-role-cluster-access" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provisioner "local-exec" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /tmp/eksctl version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /tmp/eksctl create iamidentitymapping --cluster ${local.eksClusterName} --region=${var.region} --arn ${var.userRoleARN} --group system:masters --username "AWSAdministratorAccess:{{SessionName}}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_eks_cluster.kube_cluster,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_eks_node_group.worker-node-group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>EKS worker nodes will run in public subnets, this is because I have disabled the NAT GW to save some costs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure-pipeline">Infrastructure Pipeline<a href="https://danielrive-site.github.io/blog/github-actions#infrastructure-pipeline" class="hash-link" aria-label="Direct link to Infrastructure Pipeline" title="Direct link to Infrastructure Pipeline">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="branch-strategy">Branch strategy<a href="https://danielrive-site.github.io/blog/github-actions#branch-strategy" class="hash-link" aria-label="Direct link to Branch strategy" title="Direct link to Branch strategy">​</a></h3>
<p>I will follow a common branch strategy as the following image shows. The main branch is associated with the production environment.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dxc1vvelqq1l5jjqut7d.png" alt="Branch-Strategy" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="github-actions">GitHub Actions<a href="https://danielrive-site.github.io/blog/github-actions#github-actions" class="hash-link" aria-label="Direct link to GitHub Actions" title="Direct link to GitHub Actions">​</a></h3>
<p>GitHub actions will be used to implement the pipeline to deploy the infrastructure in AWS, if you are not familiar with GitHub actions terminology you can check the <a href="https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions" target="_blank" rel="noopener noreferrer">documentation</a>.</p>
<p>You can find the YAML files in the <em>.github</em> folder, which also contains other 3 subfolders, let's explore them in detail.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="actions-folder">actions folder<a href="https://danielrive-site.github.io/blog/github-actions#actions-folder" class="hash-link" aria-label="Direct link to actions folder" title="Direct link to actions folder">​</a></h4>
<p>This folder contains the <a href="https://docs.github.com/en/actions/creating-actions/creating-a-composite-action" target="_blank" rel="noopener noreferrer">GitHub composite Actions</a> to use in the workflows, you can think of an action as a template that defines the task to execute(jobs). Now let's review the <em>terraform-plan</em> action.</p>
<p>The first part defines the name and the inputs for the action, in this case, I am just defining the working directory where TF is placed as an input.</p>
<div class="language-Yaml language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Terraform Plan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Running Terraform plan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">WORKING_DIRECTORY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'directory where the tf code is'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">required</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/infra/terraform'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The second part defines the tasks to execute, this action will start installing Terraform.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">runs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"composite"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Terraform install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'install-terraform'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hashicorp/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">terraform@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token key atrule" style="color:#00a4db">terraform_version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'${{ env.TERRAFORM_VERSION }}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Validate terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> validate</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice that the step <em>Terraform install</em> is using an external GH action, <a href="https://github.com/marketplace/actions/hashicorp-setup-terraform" target="_blank" rel="noopener noreferrer">hashicorp/setup-terraform@v2</a>, the version of this action is specified after the @. This action is available in the <a href="https://github.com/marketplace?type=actions" target="_blank" rel="noopener noreferrer">GH actions marketplace</a>.</p>
<p>The next step is to run terraform init but I won't delve into detail, therefore, let's proceed to the final two steps.</p>
<p>The step <em>Run terraform plan</em> runs the TF plan command passing some variables that are defined in the workflow definition, the plan generated is saved in a file named with the GH actions run id.</p>
<p>Finally, the plan generated in the previous step is published as an artifact, that is used for the action created for the TF apply process.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            terraform plan \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -input=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -var 'region=${{ env.AWS_REGION }}' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -var 'environment=${{ env.ENVIRONMENT }}' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -var 'project_name=${{ env.PROJECT_NAME }}' \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -out ${{ github.run_id }}.tfplan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'.${{ inputs.WORKING_DIRECTORY }}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Publish Artifact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/upload</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">artifact@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'${{ github.workspace }}${{ inputs.WORKING_DIRECTORY }}/${{ github.run_id }}.tfplan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jobs">jobs<a href="https://danielrive-site.github.io/blog/github-actions#jobs" class="hash-link" aria-label="Direct link to jobs" title="Direct link to jobs">​</a></h4>
<p>This folder stores some bash scripts used in the pipelines to perform specific tasks, currently just one script is stored here, and its purpose is to create the S3 bucket and the DynamoDB tables used for the TF state.</p>
<p>The script runs some AWS CLI commands to validate if the S3 bucket and DynamoDB table exist, if not the resources are created.</p>
<p>A composite action has been created to execute this script, you can find it with the name terraform-backend.</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Terraform backend set-up'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'set-up terraform plan'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">runs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"composite"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config tf backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">backend.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .github/workflows</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflows">Workflows<a href="https://danielrive-site.github.io/blog/github-actions#workflows" class="hash-link" aria-label="Direct link to Workflows" title="Direct link to Workflows">​</a></h4>
<p>Workflows define the triggers(commits, tags, branches...) for the pipeline and also specify the process to execute(jobs), inside the workflow you can use the composite actions already defined.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-template">Workflow Template<a href="https://danielrive-site.github.io/blog/github-actions#workflow-template" class="hash-link" aria-label="Direct link to Workflow Template" title="Direct link to Workflow Template">​</a></h5>
<p>I have created a workflow template that defines the common tasks for all the environments, but this does not define the triggers. let's take a look at the template.</p>
<div class="language-Yaml language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform deploy template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workflow_call</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">AWS_REGION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'aws region where the resources will be deployed'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">required</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">AWS_ACCOUNT_NUMBER</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">required</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The initial section defines the inputs and secrets for the workflow, the main difference between inputs and secrets is that Github hides the value of the secret in the workflow logs.</p>
<p>The second part of the template defines some common environment variables.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ENVIRONMENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> inputs.ENVIRONMENT </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AWS_REGION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> inputs.AWS_REGION </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> inputs.PROJECT_NAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">TERRAFORM_VERSION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> inputs.TERRAFORM_VERSION </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AWS_IAM_ROLE_GH</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'GitHubAction-AssumeRoleWithAction'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can observe that the value for the env variable AWS_REGION is set to the value passed by the input inputs.AWS_REGION defined earlier. Why it is done? let's review one snippet of code from the composite action for the terraform plan to gain a better understanding.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            terraform plan \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -input=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -var 'project_name=${{ env.PROJECT_NAME }}' \</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see I'm using the env variable PROJECT_NAME and passing it as a TF variable, this is possible because in the workflow I defined the value for the variable, and this is passed down in the runner. You can use inputs here but you would need to define the same input in the composite action.</p>
<p>The last part of the template defines the jobs to execute</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## Execute bash script that  create s3 bucket and dynamodb table for Terraform backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">set-up-terraform-backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> checkout</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> configure aws credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">actions/configure</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">credentials@v4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">role-to-assume</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'arn:aws:iam::${{ secrets.AWS_ACCOUNT_NUMBER }}:role/${{ env.AWS_IAM_ROLE_GH }}'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">role-session-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitHub_to_AWS_via_FederatedOIDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env.AWS_REGION </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config tf backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tf</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">backend.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .github/jobs/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The provided code shows the job to set up the Terraform backend, this job is executed in a Ubuntu runner that is defined by runs-on.</p>
<p>Let's check the steps executed for the job.</p>
<ol>
<li>The first step is to make a checkout of the repo into the runner, this is done by an <a href="https://github.com/marketplace/actions/checkout" target="_blank" rel="noopener noreferrer">external composite action</a>.</li>
<li>To execute Terraform the job needs access to AWS, this is done by an <a href="https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions" target="_blank" rel="noopener noreferrer">external composite action</a>, to avoid pass Access and Secret keys OpenID Connect (OIDC) will be used, which allows GitHub Actions workflows to access AWS. You need to create an IAM IdP in your AWS account and associate it with an IAM role, this role must contain the permissions that Terraform needs to run properly.
The details for the configuration can be checked <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services" target="_blank" rel="noopener noreferrer">here</a>.</li>
<li>Once the AWS credentials have been configured you can call the composite action created to set up the Teraform backend.</li>
</ol>
<p>The other jobs follow a similar pattern but they execute the composite actions for the Terraform plan and apply.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-template">Using the template<a href="https://danielrive-site.github.io/blog/github-actions#using-the-template" class="hash-link" aria-label="Direct link to Using the template" title="Direct link to Using the template">​</a></h5>
<p>Once the template is ready you can create the workflows for each environment. let's review the workflow for the develop environment.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Terraform infra workflow DEVELOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">run-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DEVELOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"infra/**"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">permissions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id-token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> write </span><span class="token comment" style="color:#999988;font-style:italic"># This is required for requesting the JWT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">contents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> read  </span><span class="token comment" style="color:#999988;font-style:italic"># This is required for actions/checkout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./infra/terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">### Makes a call to the workflow template defined to execute terraform, in this case, the variables define the develop environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">terraform-deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> danielrive/smart</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cash/.github/workflows/run</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">terraform</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">template.yaml@develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">AWS_REGION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'us-west-2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ENVIRONMENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'develop'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">PROJECT_NAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'smart-cash'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">TERRAFORM_VERSION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1.4.6'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">AWS_ACCOUNT_NUMBER</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.AWS_ACCOUNT_NUMBER_DEVELOP </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I have defined two triggers for the workflow, The first trigger is when new updates are pushed to <em>infra</em> folder within the develop branch, and the second trigger is when a new Pull request is open with the develop branch as a base.</p>
<p>The permissions section is necessary to generate a token used to establish the connection with AWS IAM IdP.</p>
<p>In the job definition, you can is where you can utilize the previously created template, you need to specify the path where the template is located and the values for the inputs defined in the template.</p>
<p>You can create other workflows for other environments and pass the respective values for inputs.</p>
<p>Up to this point, you've covered the first phase of this project. In the upcoming articles, you'll delve into the implementation of various other tools and continue building the project.</p>]]></content:encoded>
            <category>AWS</category>
            <category>SmartCash-Project</category>
        </item>
        <item>
            <title><![CDATA[Containers - entre historia y runtimes]]></title>
            <link>https://danielrive-site.github.io/blog/containers-history</link>
            <guid>https://danielrive-site.github.io/blog/containers-history</guid>
            <pubDate>Sun, 26 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[containers-crazy]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sox1n5tbcssth6p8eayl.png" alt="containers-crazy" class="img_ev3q"></p>
<p>Estudiando kubernetes gasté un tiempo considerable intentando entender muchos conceptos, por ejemplo, por todo lado se habla de <em>OCI compliant</em>, buscas <em>OCI</em> y te lleva a <em>runtime-spec</em>, buscas <em>runtimes</em> y te lleva a <em>containerd</em>, <em>runc</em>, <em>image-spec</em>, <em>cgroups</em>, <em>namespaces</em>, etc; puedes pasar días buscando, y mucho más cuando eres del tipo de persona que quiere entender a fondo cómo funcionan las cosas.</p>
<p>Motivado por lo anterior, me decidí a escribir este post con la idea de compartir los conceptos que logré adquirir y que me han servido para entender varias cosas del gran mundo de los containers, en algunas cosas no voy a tan bajo nivel ya que hay muchos conceptos que todavía desconozco y puedo decir cosas equiviocadas.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lo-básico">Lo básico<a href="https://danielrive-site.github.io/blog/containers-history#lo-b%C3%A1sico" class="hash-link" aria-label="Direct link to Lo básico" title="Direct link to Lo básico">​</a></h2>
<p>Iniciemos entendiendo un poco la idea detrás de los containers.</p>
<p>Containers tienen como objetivo crear un ambiente virtual <strong><em>aislado</em></strong> el cual se pueda distribuir y desplegar fácilmente. Dentro del container pueden correr diferentes procesos los cuales deben estar aislados de otros corriendo en el host. El kernel de linux ofrece distintas funcionalidades que permiten la creación de estos ambientes. Hay dos componentes principales que quizás son el core de todos los containers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="linux-namespaces">Linux namespaces<a href="https://danielrive-site.github.io/blog/containers-history#linux-namespaces" class="hash-link" aria-label="Direct link to Linux namespaces" title="Direct link to Linux namespaces">​</a></h3>
<p>Linux namespaces nos permite crear ambientes virtuales y aislados, estos particionan recursos del kernel y hacen que  sean visibles solo para los procesos que corren dentro del namespace, pero no para procesos externos. En otras palabras, namespaces nos facilitan el aislamiento entre procesos.</p>
<p>¿Qué recursos se pueden particionar?, bueno esto va a depender del <a href="https://www.redhat.com/sysadmin/7-linux-namespaces" target="_blank" rel="noopener noreferrer">tipo de namespace</a> que se este usando, por ejemplo, network namespaces nos permite encapsular los recursos relacionados con networking, como interfaces, tablas de rutas, etc. De esta forma podemos crear una red virtual dentro de nuestro namespace.</p>
<p>Este <a href="https://www.redhat.com/sysadmin/7-linux-namespaces" target="_blank" rel="noopener noreferrer">post</a> explica un poco más en detalle los namespaces.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cgroups">cgroups<a href="https://danielrive-site.github.io/blog/containers-history#cgroups" class="hash-link" aria-label="Direct link to cgroups" title="Direct link to cgroups">​</a></h3>
<p>Recordemos que el Kernel de Linux es la interfaz principal entre el hardware y los procesos, permitiendo la comunicación entre estos dos y ayudando a la gestión de recursos, por ejemplo, puede terminar procesos que consuman demasiada memoria para evitar afectar el sistema operativo. Adicionalmente pueden controlar qué procesos pueden consumir cierta cantidad de recursos.</p>
<p>cgroups es una funcionalidad del Kernel de Linux que permite organizar jerárquicamente procesos y distribuir recursos(cpu, memoria, networking, storage) dentro de dicha jerarquía.</p>
<p>Configurar cgroups puede ser un poco complejo, en mi caso estuve leyendo varios post acerca del tema y requiere cierto tiempo para entender por completo su funcionamiento. En esta <a href="https://www.redhat.com/sysadmin/cgroups-part-one" target="_blank" rel="noopener noreferrer">serie de posts</a> creados por RedHat se habla sobe cgroups y su configuración a través de systemd, pero si se desea entrar en detalle la <a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/cgroups.html" target="_blank" rel="noopener noreferrer">documentación de Linux</a> puede ser de ayuda.</p>
<p>cgroups y namespaces se convierten en los ingredientes secretos en la creación de containers, namespaces permiten aislamiento a nivel de recursos y cgroups permiten controlar los limites para dichos recursos.</p>
<p>Por suerte hoy en día con una sola linea podemos crear un container, no tenemos que entrar a configurar namespaces ni cgroups.</p>
<p>Veamos un poco de la evolución de los containers y así vamos aclarando ciertas cosas.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="un-poco-de-historia">Un poco de historia<a href="https://danielrive-site.github.io/blog/containers-history#un-poco-de-historia" class="hash-link" aria-label="Direct link to Un poco de historia" title="Direct link to Un poco de historia">​</a></h3>
<p>Docker fue el primero que popularizó los containers, era(o es) común asociar containers directamente con Docker, pero antes ya existía algo llamado LXC(Linux containers), el cual puede entenderse como un proveedor de ambientes virtuales en Linux que usa ciertos componentes del Kernel de Linux para crear ambientes aislados(containers).</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jquo7g5j5iusxgy42wv3.png" alt="Image lxc" class="img_ev3q"></p>
<p>LXC se encuentra dentro del user-space, es decir, nosotros interactuamos con LXC y este se encarga de interactuar con los componentes del kernel para permitir la creación de containers. Aqui un <a href="https://www.youtube.com/watch?v=aIwgPKkVj8s" target="_blank" rel="noopener noreferrer">video</a> en donde se puede ver LXC en acción.</p>
<blockquote>
<p><strong>Nota:</strong> Antes de LXC ya se habían desarrollado otros alternativas para la creación de containers como OpenVZ y Linux Vserver. LXC es mencionado inicialmente ya que es lo más cercano a Docker que es el software con el que muchos iniciamos interactuando con containers.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="la-llegada-de-docker">La llegada de Docker<a href="https://danielrive-site.github.io/blog/containers-history#la-llegada-de-docker" class="hash-link" aria-label="Direct link to La llegada de Docker" title="Direct link to La llegada de Docker">​</a></h4>
<p>Docker empaquetó LXC en una herramienta que facilitaba más la creación de containers. Al ganar popularidad se crearon mejoras y unos meses después Docker lanzó <a href="https://github.com/opencontainers/runc/tree/main/libcontainer" target="_blank" rel="noopener noreferrer">libcontainer</a> el cual está escrito en <a href="https://github.com/opencontainers/runc/tree/main/libcontainer" target="_blank" rel="noopener noreferrer">Golang</a> y básicamente reemplazaba LXC.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ydjpgj8o2rmm15btbqet.png" alt="Docker libcontainer" class="img_ev3q"></p>
<p>Docker se enfocó más en la creación de containers optimizados para el despliegue de aplicaciones mejorando la portabilidad. Este <a href="https://earthly.dev/blog/lxc-vs-docker/" target="_blank" rel="noopener noreferrer">post</a> explica más detalladamente las diferencias entre LXC y Docker.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="definiendo-un-estándar-para-containers">Definiendo un estándar para containers<a href="https://danielrive-site.github.io/blog/containers-history#definiendo-un-est%C3%A1ndar-para-containers" class="hash-link" aria-label="Direct link to Definiendo un estándar para containers" title="Direct link to Definiendo un estándar para containers">​</a></h4>
<p>Como alternativa a Docker, empezaron a surgir otras opciones,CoreOS por su parte lanzó <a href="https://www.redhat.com/en/topics/containers/what-is-rkt" target="_blank" rel="noopener noreferrer">rkt(2014)</a> proponiendo mejores de seguridad, CoreOS <a href="https://lwn.net/Articles/623875/" target="_blank" rel="noopener noreferrer">argumentaba</a> que Docker había sido construido como un monolito el cual corría como root en el host, abriendo posibilidades a comprometer todo el host en el caso de un ataque.</p>
<p>rkt usa <a href="https://github.com/appc" target="_blank" rel="noopener noreferrer">appc(open source container)</a> con el fin de mejorar la operabilidad, appc tiene como propósito crear un estándar general para crear containers buscando ser vendor-independent y OS-independent.</p>
<p>Otras iniciativas empezaron a surgir debido a la alta popularidad de los containers y debido a esto, en 2015 se crea <a href="https://opencontainers.org/about/overview/" target="_blank" rel="noopener noreferrer">OCI(Open Container Initiative)</a> para definir un estandar para containers(<a href="https://github.com/opencontainers/runtime-spec/blob/main/spec.md" target="_blank" rel="noopener noreferrer">runtimes</a> e <a href="https://github.com/opencontainers/image-spec/blob/main/spec.md" target="_blank" rel="noopener noreferrer">imagenes</a>).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="oci-runtime-spec">OCI Runtime spec<a href="https://danielrive-site.github.io/blog/containers-history#oci-runtime-spec" class="hash-link" aria-label="Direct link to OCI Runtime spec" title="Direct link to OCI Runtime spec">​</a></h4>
<p><em>Runtime spec</em> define la configuración(archivo JSON), ambiente y ciclo de vida de un container. Las configuraciones son definidas en un archivo llamado config.json, el cual contiene la metadata necesaria para la ejecución del container, este archivo es definido de acuerdo a plataforma a usar(windows, linux, solaris, etc).</p>
<p>otro concepto a destacar es el <em>filesystem bundle</em>, este es un grupo de archivos con la data y metadata para correr un container. Los principales archivos que deben contener son, el config.json mencionado anteriormente y el <a href="https://www.baeldung.com/linux/rootfs" target="_blank" rel="noopener noreferrer">rootfs(linux file system)</a>, este  <em>filesystem bundle</em> se genera a través del container image.</p>
<p>Todas las especificaciones para el container runtime son descritas <a href="https://github.com/opencontainers/runtime-spec/blob/main/spec.md" target="_blank" rel="noopener noreferrer">aqui</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="oci-image-spec">OCI Image spec<a href="https://danielrive-site.github.io/blog/containers-history#oci-image-spec" class="hash-link" aria-label="Direct link to OCI Image spec" title="Direct link to OCI Image spec">​</a></h4>
<p>Docker en sus inicios ya había definido las especificaciones para la creación de imágenes<a href="https://docs.docker.com/registry/spec/manifest-v2-2/" target="_blank" rel="noopener noreferrer">Image Manifest 2 Schema Version 2</a>, al ser el más popular, OCI partió de este para crear un estándar más general, que no estuviera asociado a un vendor en específico. <em>Image spec</em> define como construir y empaquetar container images, personalmente no he entendido del todo el funcionamiento pero aquí está la url del <a href="https://github.com/opencontainers/image-spec" target="_blank" rel="noopener noreferrer">repo</a> y un <a href="https://blog.quarkslab.com/digging-into-the-oci-image-specification.html" target="_blank" rel="noopener noreferrer">blog-post</a> que contienen mayor información.</p>
<p>Haciendo uso del <em>Image spec</em>, se puede crear un container image que puede ser ejecutada por cualquier <em>OCI Runtime</em>, esto quiere decir que a través del <em>Image spec</em> se puede generar el <em>filesystem bundle</em>, el cual es usado por el runtime para la creación y ejecución del container.</p>
<blockquote>
<p>The Runtime Specification outlines how to run a "filesystem bundle" that is unpacked on disk. At a high-level an OCI implementation would download an OCI Image then unpack that image into an OCI Runtime filesystem bundle. At this point the OCI Runtime Bundle would be run by an OCI Runtime.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="container-runtimes-y-kubernetes">Container runtimes y Kubernetes<a href="https://danielrive-site.github.io/blog/containers-history#container-runtimes-y-kubernetes" class="hash-link" aria-label="Direct link to Container runtimes y Kubernetes" title="Direct link to Container runtimes y Kubernetes">​</a></h4>
<p>En el 2015 se lanza el primer release de kubernetes, el cual usaba Docker como runtime.</p>
<p>Docker decide dividir el monolito creado. libcontainer es donado a OCI y Docker empieza a trabajar en un proyecto llamado runC, este se puede ver como una herramienta que lee OCI specifications e interactúa con libcontainer para la creación de containers. runC es independiente del Docker Engine y es donado a OCI.</p>
<p>runC es una low-level runtime por lo que también se desarrolla <em>containerd</em> el cual es como una interfaz entre el cliente y runC.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zi3mkr4s6u5bbmj3y9ls.png" alt="docker-runc-containerd" title="fuente: https://images.techhive.com/images/article/2016/04/docker-runc-100656060-large.idge.png" class="img_ev3q"></p>
<p>Hasta el momento solo se ha cubierto parte del origen de los container y el origen de algunas herramientas que seguimos viendo hoy en día como runC y conteinerd. En lo que sigue del post trataré de exponer un poco más a fondo las <em>container images</em> al igual que algunas <em>containers runtimes</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-images">Container Images<a href="https://danielrive-site.github.io/blog/containers-history#container-images" class="hash-link" aria-label="Direct link to Container Images" title="Direct link to Container Images">​</a></h3>
<p>Antes de entrar a ver las <em>containers runtimes</em>, es importante entender qué es lo que contienen las <em>containers images</em>, para ello vamos a usar <a href="https://www.redhat.com/en/topics/containers/what-is-skopeo" target="_blank" rel="noopener noreferrer">Skopeo</a>.</p>
<p>Skopeo permite manipular e inspeccionar <em>container images</em> ya sea para Windows, Linux o MacOs. En este caso vamos a usar Skopeo para obtener "el contenido" de una imagen que se encuentra en DockerHub, esto es muy similar al comando <a href="https://docs.docker.com/engine/reference/commandline/export/" target="_blank" rel="noopener noreferrer">docker export</a>,pero en este caso no vamos a instalar Docker.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="copiando-images-con-skopeo">copiando images con skopeo<a href="https://danielrive-site.github.io/blog/containers-history#copiando-images-con-skopeo" class="hash-link" aria-label="Direct link to copiando images con skopeo" title="Direct link to copiando images con skopeo">​</a></h4>
<p>Para instalar skopeo se puede usar snap en ubuntu</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo snap install skopeo --edge</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>una vez que finalice la instalación podemos copiar una imagen que se encuentra en DockerHub a nuestro local. En este caso se va a usar la imagen de golang.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo skopeo --insecure-policy copy docker://golang:latest  oci://home/ubuntu/example-dev-to/golang-image-v2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Skopeo copia el contenido de la imagen en el destino especificado, en este caso <code>oci:/home/ubuntu/example-dev-to/golang-image-v2</code>. En la imagen se puede ver que se tiene un archivo index.json, oci-layout y un directorio llamado blobs. Esto corresponde a la estructura de archivos definidos por <a href="https://github.com/opencontainers/image-spec/blob/main/spec.md" target="_blank" rel="noopener noreferrer">OCI</a></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f76zraaa4bdgws82wr9f.png" alt="golang-copy-skopeo" class="img_ev3q"></p>
<p>el <em>index.json</em> se puede entender como un resumen de la imagen, en donde se ve el sistema operativo y la arquitectura, además se especifica la ubicación del <em>image manifest</em>.</p>
<p>El <em>image manifest</em> contiene metadata de la imagen al igual que las especificaciones de cada layer creada.</p>
<p>Revisando el index.json vamos a encontrar lo siguiente:</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wxaqowqg0vbmhjvsgvsq.png" alt="index.json golang image" class="img_ev3q"></p>
<p>Se puede ver información acerca del sistema operativo y arquitectura soportados por la imagen. El digest(linea 6) nos indica en que archivo se encuentra el manifest.json.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7tyogxsh5q90vgolsvbu.png" alt="manifest" class="img_ev3q"></p>
<p>En el manifest(imagen anterior) se puede ver el digest para el config file y para cada una de las layers que se tienen. El <a href="https://github.com/opencontainers/image-spec/blob/main/media-types.md" target="_blank" rel="noopener noreferrer">mediaType</a> puede entenderse como el formato de cada archivo, por ejemplo la linea 4 nos dice que el archivo config de formato json se puede identificar con el digest <code>bdba673e96d6e9707e2a724103e8835dbdd11dc81ad0c76c4453066ed8db29fd</code>. Este se puede encontrar en la carpeta blobs y va a lucir como la siguiente imagen.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/74dolefjcdzij0qhcf3d.png" alt="config.json" class="img_ev3q"></p>
<p>Este archivo ya contiene más información de la imagen, por ejemplo podemos ver el workdir y algunas variables de entorno.</p>
<p>pasemos ahora a las layers, en el manifest podemos identificar los digest para cada layers, si vemos el media type nos indica que es <code>v1.tar+gzip</code>, en este caso tenemos que descomprimir el contenido de dicho digest, para ello vamos a usar <code>tar</code></p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fd5iwfpygp71jutt0qcx.png" alt="unpackage-digest" class="img_ev3q"></p>
<p>Una vez termine el proceso podemos analizar el resultado, en este caso vamos a tener una serie de directorios que representan el rootfs de la imagen, estos archivos van a hacer parte de un layer en específico. Si observamos la siguente imagen podemos ver que tenemos /home, /etc y /bin, etc, los cuales representan el sistema de archivos de linux(rootfs).</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/clm54sgl7p2i08gtrd1b.png" alt="rootfs" class="img_ev3q"></p>
<p>Con esto vemos a alto nivel el contenido de un <em>container image</em>, al final el <em>container runtime</em> es el que se encarga de descomprimir y leer todos estos archivos, el cual va a ser usado para correr el container.</p>
<p>Hasta aquí va la primera parte de este post, en la siguiente veremos un poco m'as los container runtimes.</p>]]></content:encoded>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[Enabling logs and alerting in AWS EKS cluster - CloudWatch Log Insights and Metric filters]]></title>
            <link>https://danielrive-site.github.io/blog/Log-Insights</link>
            <guid>https://danielrive-site.github.io/blog/Log-Insights</guid>
            <pubDate>Tue, 10 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[fluent-bit]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" alt="fluent-bit" src="https://danielrive-site.github.io/assets/images/fluent-bit-logo-995cb8446c870684693ead3ced70e0d5.png" width="1000" height="420" class="img_ev3q"></p>
<p>AWS CloudWatch Logs could be used to store logs generated by resources created in AWS or external resources, once the logs are in CloudWatch you can run some queries to get specific information and create alerts for specific events.</p>
<p>In the <a href="https://dev.to/aws-builders/enabling-logs-and-alerting-in-eks-cluster-part-1-2gnb" target="_blank" rel="noopener noreferrer">first part</a> of this post, I described the steps to enable logs in an EKS cluster, control plane logs, and container logs using Fluent-bit and CloudWatch, in this post I will show how to get helpful information from logs and create alerts for specific events.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudwatch-log-insights">CloudWatch Log Insights<a href="https://danielrive-site.github.io/blog/Log-Insights#cloudwatch-log-insights" class="hash-link" aria-label="Direct link to CloudWatch Log Insights" title="Direct link to CloudWatch Log Insights">​</a></h2>
<p>CloudWatch Logs Insights allows search and analysis of log data stored in Amazon CloudWatch Logs, queries can be run to identify potential causes and validate fixes, an advantage of Logs Insights is the ability to discover fields, doing more easy the process to run queries. Automatically Logs Insights define 5 fields:</p>
<ol>
<li>
<p>message: This field contains the original log message sent to CloudWatch.</p>
</li>
<li>
<p>timestamp: contains the event timestamp registered in the original event.</p>
</li>
<li>
<p>ingestionTime: contains the time when CloudWatch Logs received the log event.</p>
</li>
<li>
<p>logStream: contains the name of the log stream where the event was added.</p>
</li>
<li>
<p>log: it is an identifier in the form of account-id<!-- -->:log-group-name<!-- -->. When querying multiple log groups, this can be useful to identify which log group a particular event belongs to.</p>
</li>
</ol>
<p>Those fields are discovered by CloudWatch and depending on the log type that we are using CloudWatch will discover more fields, for instance, for EKS control plane logs you can see the field shown in the following image:</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qfrfyooqek9dp5mj58zl.png" alt="EKS logs insights fields" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-queries-in-aws-log-groups">Running queries in AWS Log Groups<a href="https://danielrive-site.github.io/blog/Log-Insights#running-queries-in-aws-log-groups" class="hash-link" aria-label="Direct link to Running queries in AWS Log Groups" title="Direct link to Running queries in AWS Log Groups">​</a></h2>
<p>Queries can be run to search specific events, the field discovery is really helpful in designing the query to run, in some cases when you don't know the structure of the logs you can run a simple query to get the fields that CloudWatch discovered, and use them to design the query based on the use case.</p>
<p>An important thing to mention here is if the CloudWatch log groups have been encrypted by KMS you must have permission to use the key.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-run-queries">How to run queries?<a href="https://danielrive-site.github.io/blog/Log-Insights#how-to-run-queries" class="hash-link" aria-label="Direct link to How to run queries?" title="Direct link to How to run queries?">​</a></h3>
<ol>
<li>
<p>Go to AWS CloudWatch service, in the left panel select Logs Insights.</p>
</li>
<li>
<p>Select the logs groups to run queries, up to 20 log groups can be selected, Logs Insights will search in the groups specified.</p>
</li>
<li>
<p>By default CloudWatch shows a simple query, you can run it and validate the fields discovered by CloudWatch. The following image shows a query that gets up to 10 results, you can check it and validate the fields.</p>
</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pjk584k97xwc5jfcvik5.png" alt="logs insights panel" class="img_ev3q"></p>
<p><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html" target="_blank" rel="noopener noreferrer">AWS documentation</a> describes the query sintax that you can use.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="queries-examples-for-eks">Queries examples for EKS<a href="https://danielrive-site.github.io/blog/Log-Insights#queries-examples-for-eks" class="hash-link" aria-label="Direct link to Queries examples for EKS" title="Direct link to Queries examples for EKS">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="search-api-calls-made-by-kubectl-user-agent">Search API calls made by kubectl user-agent<a href="https://danielrive-site.github.io/blog/Log-Insights#search-api-calls-made-by-kubectl-user-agent" class="hash-link" aria-label="Direct link to Search API calls made by kubectl user-agent" title="Direct link to Search API calls made by kubectl user-agent">​</a></h5>
<p>The following example searches the calls made to Kube API using the kubectl command and with the GET action. In this case, the log group is the one that EKS has created when you enable logging in the cluster, in the <a href="https://dev.to/aws-builders/enabling-logs-and-alerting-in-eks-cluster-part-1-2gnb" target="_blank" rel="noopener noreferrer">previous</a> post I mentioned the name-format and how to enable it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @logStream like /kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter userAgent like /kubectl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb like /(get)/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first line is used to specify the fields that you want to show in the results, the query in the example will show the logStream name, the timestamp, and the message, you can add the fields that you want.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nuvbm555wmrtljw00j16.png" alt="results in cloudwatch insights" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="search-events-filtering-by-namespace">Search events filtering by namespace<a href="https://danielrive-site.github.io/blog/Log-Insights#search-events-filtering-by-namespace" class="hash-link" aria-label="Direct link to Search events filtering by namespace" title="Direct link to Search events filtering by namespace">​</a></h5>
<p>You can use the fields discovered by CloudWatch to create your queries, in this case for EKS control logs, one field discovered is objectRef.namespace, and the following query uses it to get the events where the kube-system namespace is used.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fields @timestamp, @message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter objectRef.namespace like 'kube-system'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result of the previous query could look like:</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uheuwtcxtarzt82q08a6.png" alt="results-filter-by-namespace" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-alerts-for-specific-events">Creating alerts for specific events<a href="https://danielrive-site.github.io/blog/Log-Insights#creating-alerts-for-specific-events" class="hash-link" aria-label="Direct link to Creating alerts for specific events" title="Direct link to Creating alerts for specific events">​</a></h2>
<p>CloudWatch logs can look for specific patterns inside the events that are sent, this allows the creation of metrics to monitor if a particular event happened and create alerts for this, for that we need to use AWS CloudWatch metric filters, this is configured directly in the Log group created and you must specify a pattern.</p>
<p>To create a metric filter you must select the Log Group to use, then in actions, you will see the option to create a metric filter.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/phprngsvpd5w70kee11i.png" alt="enable-metric-filter" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-a-pattern-for-the-filter">Defining a pattern for the filter<a href="https://danielrive-site.github.io/blog/Log-Insights#defining-a-pattern-for-the-filter" class="hash-link" aria-label="Direct link to Defining a pattern for the filter" title="Direct link to Defining a pattern for the filter">​</a></h3>
<p>When you are creating the filter you need to define a pattern to specify what to look for in the log file. When the logs are in JSON format is more easily define the pattern because you just need to specify the name of the key that you want to evaluate, for this case you can use the following format:</p>
<p><code>{ PropertySelector Operator Value }</code></p>
<p>For more details about the pattern syntax you can check the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html" target="_blank" rel="noopener noreferrer">AWS documentation</a>.</p>
<p>When the logs are not in JSON format is more tricky define the pattern , in this case you need to take in mind that each space is taken as a word in the filter, for instance, suppose that you have the following log event:</p>
<p><code>time="2022-10-09T20:37:25Z" level=info msg="STS response" accesskeyid=ABCD1234 accountid=123456789 arn="arn:aws:sts::123456789:assumed-role/test" client="127.0.0.1:1234" method=POST path=/authenticate</code></p>
<p>In this case, you have different words separated by space, if you want to look for some word specific you need to know the exact position of the element to compare, let's see this with an example, in this case, i want to match the logs with a level equal to info, if you see the previous log event you can validate that leve=info is the word number 2 in the whole event, in this case, the pattern could be:</p>
<p><code>[word1,word2="level=info",word3]</code></p>
<p>Remember that you need to include the whole word that you want to compare in this case you can use leve=info or you put the word between * which means any match with the word specified. let's see the result of the previous pattern.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/21xd2b0o94kejzot1amn.png" alt="Results-metrics-filter" class="img_ev3q"></p>
<p>If you see, CloudWatch is showing each word defined in the pattern and the events that match.</p>
<p>Let's see more examples to be more clear</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metric-filter-to-alert-when-actions-are-made-in-aws-auth-configmap">Metric Filter to alert when actions are made in AWS-AUTH configmap<a href="https://danielrive-site.github.io/blog/Log-Insights#metric-filter-to-alert-when-actions-are-made-in-aws-auth-configmap" class="hash-link" aria-label="Direct link to Metric Filter to alert when actions are made in AWS-AUTH configmap" title="Direct link to Metric Filter to alert when actions are made in AWS-AUTH configmap">​</a></h4>
<p>AWS-AUTH configmap is used to authenticate the user by IAM RBAC, and part of this kind of event looks like the following message:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kind:Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">level: Metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectRef.apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectRef.name: aws-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectRef.namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectRef.resource: configmaps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">verb: get</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Unauthorized modifications in this configmap could be a security risk, a metric filter can be created to alert when this configmap is edited. The pattern could be:</p>
<p><code>{( $.objectRef.name = "aws-auth" &amp;&amp; $.objectRef.resource = "configmaps" ) &amp;&amp;  ($.verb = "delete" || $.verb = "create" || $.verb = "patch"  ) }</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metric-filter-for-403-code-response-in-calls-to-k8-api-server">Metric filter for 403 code response in calls to K8 API-SERVER<a href="https://danielrive-site.github.io/blog/Log-Insights#metric-filter-for-403-code-response-in-calls-to-k8-api-server" class="hash-link" aria-label="Direct link to Metric filter for 403 code response in calls to K8 API-SERVER" title="Direct link to Metric filter for 403 code response in calls to K8 API-SERVER">​</a></h4>
<p>This is useful to detect several attempts to login or make calls to the cluster without valid credentials, part of this event looks like the following message:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">requestURI: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responseStatus.code:403</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responseStatus.reason: Forbidden</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responseStatus.status: Failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sourceIPs.0 : 12.34.56.78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">verb: get</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The pattern could be:</p>
<p><code>{$.responseStatus.code = "403" }</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metric-filter-to-check-access-denied-generated-by-aws-iam-rbac">Metric filter to check Access Denied generated by AWS IAM-RBAC<a href="https://danielrive-site.github.io/blog/Log-Insights#metric-filter-to-check-access-denied-generated-by-aws-iam-rbac" class="hash-link" aria-label="Direct link to Metric filter to check Access Denied generated by AWS IAM-RBAC" title="Direct link to Metric filter to check Access Denied generated by AWS IAM-RBAC">​</a></h4>
<p>You can monitor the number access-denied in API calls, this is generated by the AWS IAM-RBAC, part of this event looks like the following message:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">authenticator-8c7,2022-08-08 10:04:56,"time=""2020-08-04T28:43:44Z"" level=warning msg=""access denied"" client=""127.0.0.1:1234"" error=""sts getCallerIdentity failed: error from AWS (expected 200, got 403)"" method=POST path=/authenticate"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The pattern could be:</p>
<p><code>[time,level="*warning*",message1="*access*",message2="*denied*",more]</code></p>]]></content:encoded>
            <category>AWS</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[Enabling logs and alerting in AWS EKS cluster - CloudWatch and fluent-bit]]></title>
            <link>https://danielrive-site.github.io/blog/fluentbit-cloudwatch</link>
            <guid>https://danielrive-site.github.io/blog/fluentbit-cloudwatch</guid>
            <pubDate>Thu, 10 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[robber-duck-logs]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tsflwyqektvsf6vepwj9.jpg" alt="robber-duck-logs" class="img_ev3q"></p>
<p>In this post I will share my experience enabling and configuring logging in an EKS cluster, creating alerts to send a notification when a specific event appears in the logs.</p>
<p>Logs are a fundamental component in our environments, these provide useful information that helps to debug in the case of any issue or to identify events that can affect the security of the application. Logs should be enabled in each component, from the infrastructure level to the application level. This brings some challenges like where to store the logs, what kind of events log, how to search events, and what to do with the logs.</p>
<p>This is the part #1 in which I show how to enable control plane logging and container logging in an EKS cluster, in <a href="https://dev.to/aws-builders/enabling-logs-and-alerting-in-eks-cluster-part-2-log-insights-and-metric-filters-3ped" target="_blank" rel="noopener noreferrer">the part #2</a> I will show you how to enable some alerts using the logs groups created.</p>
<p>Before to start is important to mention that logs can contain private data like user information, keys, passwords, etc. For this reason, logs should be encrypted at rest and enable restrictions to access them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-control-plane-logging">Kubernetes Control Plane logging<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#kubernetes-control-plane-logging" class="hash-link" aria-label="Direct link to Kubernetes Control Plane logging" title="Direct link to Kubernetes Control Plane logging">​</a></h2>
<p>Kubernetes architecture can be divided into a control plane and worker nodes, control plane contains the components that manage the cluster, components like etcd, API Server, Scheduler, and Controller Manager. Almost every action done in the cluster pass through the API Server that logs each event.</p>
<p>AWS EKS manages the control plane for us, deploying and operating the necessary components. By default, EKS doesn't have logging enabled and actions from our side are required. Enabling EKS control plane logging is an easy task, you need to know what component log and enable it. You can enable logs for the API server, audit, authenticator, control manager, and scheduler.</p>
<p>In my opinion, audit logs and authenticator are useful because records actions done in our cluster and help us to understand the origin of the actions and requests generated by the IAM authenticator.</p>
<p>By terraform you can use the following code to create a simple cluster and enabling audit,api,authenticator, and scheduler logs.</p>
<div class="language-Terraform language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_eks_cluster" "kube_cluster" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                      = "test-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role_arn                  = aws_iam_role.role-eks.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version                   = "1.22"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled_cluster_log_types = ["audit", "api", "authenticator","scheduler"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnet_ids              = ["sub-1234","sub-5678"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint_private_access = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint_public_access  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Logs are stored in AWS CloudWatch logs and the log group is created automatically following this name structure <code>/aws/eks/&lt;cluster-name&gt;/cluster</code>, inside the group you can find the log stream for each component that you enabled</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">authenticator-123abcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-123abcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-123abcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By default, the Log group created by AWS doesn't have encryption and retention days enabled, I recommend creating the logs group by yourself and specifying and KMS Key, and setting some time to expiry the logs, Kubernetes generates a considerable number of logs that will increase the size of the group that can impact the billing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-containers-logging">Kubernetes Containers logging<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#kubernetes-containers-logging" class="hash-link" aria-label="Direct link to Kubernetes Containers logging" title="Direct link to Kubernetes Containers logging">​</a></h2>
<p>The steps mentioned above were to enable just logging in the control plane, to send logs generated by the applications running in the containers a log aggregator is necessary, in this case, I will use <a href="https://fluentbit.io/how-it-works/" target="_blank" rel="noopener noreferrer">Fluent-Bit</a></p>
<p>Fluent-Bit runs as a daemonSet in the cluster and sends logs to CloudWatch Logs. Fluent-Bit creates the log groups using the configuration specified in the kubernetes manifests.</p>
<p>Here is important to mention that AWS has created a docker image for the daemonSet, this can be found in this <a href="https://github.com/aws/aws-for-fluent-bit" target="_blank" rel="noopener noreferrer">link</a>.</p>
<p><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html" target="_blank" rel="noopener noreferrer">AWS describes the steps</a> to run the daemonSet, this is done by some commands, but I will use a Kubernetes manifest that can be stored in our repository and then use Argo or Fluxcd to automate deployments.</p>
<p>The following steps show the manifests to create the objects that Kubernetes needs to send containers logs to CloudWatch, you must have access to the cluster and by kubeclt command create the resources (<code>kubeckt apply -f manifest-name.yml</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-namespace-creation">1. Namespace creation<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#1-namespace-creation" class="hash-link" aria-label="Direct link to 1. Namespace creation" title="Direct link to 1. Namespace creation">​</a></h3>
<p>A K8 namespace is necessary, <em><strong>amazon-cloudwatch</strong></em> name will use for this, you can change the name but make sure to use the same in the following steps.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-configmap-for-aws-fluent-bit-general-configs">2. ConfigMap for aws-fluent-bit general configs<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#2-configmap-for-aws-fluent-bit-general-configs" class="hash-link" aria-label="Direct link to 2. ConfigMap for aws-fluent-bit general configs" title="Direct link to 2. ConfigMap for aws-fluent-bit general configs">​</a></h3>
<p>This configMap is necessary to specify some configurations for fluent-bit and for AWS, for instance, the cluster-name AWS use to create the logs group. In this case, I don't want to create an HTTP server for fluent-bit and I will read the logs from the tail, more information about this can be found <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/classic-mode/configuration-file" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">general</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">configs </span><span class="token comment" style="color:#999988;font-style:italic">## you can use a different name, make sure to use the same in the following steps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cluster.name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CLUSTERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http.port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http.server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Off"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">logs.region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">AWS_REGION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">read.head</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Off"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">read.tail</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"On"</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3service-account-cluster-role-and-role-binding">3.Service Account, Cluster Role and Role Binding<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#3service-account-cluster-role-and-role-binding" class="hash-link" aria-label="Direct link to 3.Service Account, Cluster Role and Role Binding" title="Direct link to 3.Service Account, Cluster Role and Role Binding">​</a></h3>
<p>Some permissions are required to send logs from daemonSet to Cloudwatch, you can attach a role to the worker-nodes or use a service account with an IAM role, in this case, I will create an IAM role and associate it with a service account.
The following Terraform code creates a policy and the role.</p>
<div class="language-Terraform language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_iam_role" "iam-role-fluent-bit" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = "role-fluent-bit-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  force_detach_policies = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max_session_duration  = 3600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path                  = "/"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assume_role_policy    = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version= "2012-10-17"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Statement= [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Effect= "Allow"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Principal= {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Federated= "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.${REGION}.amazonaws.com/id/${EKS_OIDCID}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Action= "sts:AssumeRoleWithWebIdentity"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Condition= {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          StringEquals= {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "oidc.eks.${REGION}.amazonaws.com/id/${EKS_OIDCID}:aud": "sts.amazonaws.com",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"oidc.eks.${REGION}.amazonaws.com/id/${EKS_OIDCID}:sub": "system:serviceaccount:${AWS_CLOUDWATCH_NAMESPACE}:${EKS-SERVICE_ACCOUNT-NAME}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>EKS_OIDCID:</strong> is the OpenID Connect for your cluster, you can get it in the cluster information or by terraform outputs.</li>
<li><strong>AWS_CLOUDWATCH_NAMESPACE:</strong> is the namespace create in the step 1, in this case amazon-cloudwatch.</li>
<li><strong>ACCOUNT_ID:</strong> is the AWS account number where the cluster was created.</li>
</ul>
<p>The role needs a policy with permissions to create and put logs in cloudwatch, you can use the following code to create the policy and attach it to IAM Role created.</p>
<div class="language-Terraform language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_iam_policy" "policy_sa_logs" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = "policy-sa-fluent-bit-logs"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path        = "/"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = "policy for EKS Service Account fluent-bit "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy = &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "Version": "2012-10-17",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "Statement": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Effect": "Allow",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Action": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "cloudwatch:PutMetricData",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "ec2:DescribeVolumes",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "ec2:DescribeTags",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:PutLogEvents",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:DescribeLogStreams",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:DescribeLogGroups",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:CreateLogStream",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:CreateLogGroup",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "logs:PutRetentionPolicy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Resource": "arn:aws:logs:${REGION}:${ACCOUNT_ID}:*:*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">######## Policy attachment to IAM role ########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_iam_role_policy_attachment" "policy-attach" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.iam-role-fluent-bit.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = aws_iam_policy.policy_sa_logs.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the role has been created the Service account can be created, you can use the following k8 manifest for that, you should replace the IAM_ROLE variable for the ARN of the role created previously.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${IAM_ROLE}"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the SA ready, you need to create a cluster role and associate that to the SA created, the following manifests can be used for that.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">nonResourceURLs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> pods/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodes/proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"get"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"list"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"watch"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">role</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4configmap-for-fluent-bit-configurations">4.ConfigMap for fluent-bit configurations<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#4configmap-for-fluent-bit-configurations" class="hash-link" aria-label="Direct link to 4.ConfigMap for fluent-bit configurations" title="Direct link to 4.ConfigMap for fluent-bit configurations">​</a></h3>
<p>A ConfigMap is used to specify a detailed configuration for Fluent-bit, AWS already defines a configuration, but you can add custom configs, The following <a href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml" target="_blank" rel="noopener noreferrer">link</a>, shows the configurations defined by AWS, if you see, the first objects created in the YAML are the manifest defined in previous steps, in this step you just need to define the ConfigMap with name <em>fluent-bit-config</em>, I don't want to put here all the manifest because is a little long and can complicate the lecture of this post.</p>
<p>With this ConfigMap, Fluent Bit will create the log groups in the below table, you also have the option to create by terraform and specify encryption and retention period (i recommend this way).</p>
<table><thead><tr><th>CloudWatch Log Group Name</th><th>Source of the logs(Path inside the Container)</th></tr></thead><tbody><tr><td>aws/containerinsights/Cluster_Name/application</td><td>All log files in /var/log/containers</td></tr><tr><td>/aws/containerinsights/Cluster_Name/host</td><td>Logs from /var/log/dmesg, /var/log/secure, and /var/log/messages</td></tr><tr><td>/aws/containerinsights/Cluster_Name/dataplane</td><td>The logs in /var/log/journal for kubelet.service, kubeproxy.service, and docker.service.</td></tr></tbody></table>
<p>If you analyze the ConfigMap you can see the INPUTS for each source mentioned in the table.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> OTHER CONFIGS </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### here is the INPUT configurations for application logs  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">application-log.conf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    [INPUT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        Name                tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        Tag                 application.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        Exclude_Path        /var/log/containers/cloudwatch-agent*, /var/log/containers/fluent-bit*, /var/log/containers/aws-node*, /var/log/containers/kube-proxy*</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        Path                /var/log/containers/*.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> OTHER CONFIGS </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OUTPUT</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name                cloudwatch_logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Match               application.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        region              $$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">AWS_REGION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log_group_name      /aws/containerinsights/$$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CLUSTER_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log_stream_prefix   $$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">HOST_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto_create_group   false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extra_user_agent    container</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">insights</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log_retention_days  $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">logs_retention_period</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The OUTPUT in the previous manifest defines the CloudWatch log Group configuration that fluent bit will create, as you can see you can specify if the log groups should be created, the prefix for the stream, the name, and the retention period for the logs. If you are using Terraform you should set to false the option <em>auto_create_group</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5daemonset-creation">5.DaemonSet Creation<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#5daemonset-creation" class="hash-link" aria-label="Direct link to 5.DaemonSet Creation" title="Direct link to 5.DaemonSet Creation">​</a></h3>
<p>This is the last step, AWS also provides the manifest to create the DaemonSet, in this <a href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml" target="_blank" rel="noopener noreferrer">link</a> you can find it in the bottom of the file. As I mentioned, I don't want to put the whole file here, you can copy and paste the content or edit the file if you have custom configurations.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazon</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloudwatch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluent</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> OTHER CONFIGS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you have run the above steps, you can validate that the daemonSet is running well and if everything is ok you should be the Logs groups in the AWS console with some events passed by fluent-bit DaemonSet</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://danielrive-site.github.io/blog/fluentbit-cloudwatch#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h3>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html" target="_blank" rel="noopener noreferrer">Container-Insights-setup-logs-FluentBit</a></li>
<li><a href="https://docs.fluentbit.io/manual/pipeline/outputs/cloudwatch" target="_blank" rel="noopener noreferrer">fluentbit official</a></li>
</ul>]]></content:encoded>
            <category>AWS</category>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[AWS Event-Bridge and Lambda to copy RDS snapshots to another Region]]></title>
            <link>https://danielrive-site.github.io/blog/Event-Bridge-Lambda</link>
            <guid>https://danielrive-site.github.io/blog/Event-Bridge-Lambda</guid>
            <pubDate>Wed, 02 Mar 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Architecture Diagram]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6rjyhs8hmbwc76fkztos.png" alt="Architecture Diagram" class="img_ev3q"></p>
<p>A few months ago I was asked to design the DRP process(Multi-Region) for a project that used RDS(PostgreSQL). RDS instances were critical components, these stored PII information. RDS automatically takes snapshots of the instances and you can use them to recreate the instances in case of failure, these snapshots just can be used in the same region but you can share or copy them between accounts and Regions, here some <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html" target="_blank" rel="noopener noreferrer">AWS Docs related RDS automatic snapshots</a>.</p>
<p>My initial idea was to create a K8 job to run pg_dump for each RDS instance and then, upload the file to an S3 bucket created in a different region, not too bad but this requires more work to backup and restore. so I decided to copy snapshots between regions, a new challenge appeared here, how to automate that copy? In this post I will show the approach that I follow to solve this, one crucial point to mention here is that for a big number of snapshots, this solution could not be the best due to some limitations that AWS RDS to copy snapshots.</p>
<p>AWS Documentation says:</p>
<blockquote>
</blockquote>
<p>"You can have up to 20 snapshot copy requests in progress to a single destination Region per account."</p>
<p>This approach uses AWS event-bridge and Lambda to automate the copy process, at summary, even-bridge detects that a new RDS snapshot has been created and triggers a lambda function to copy the snapshot to the other region.</p>
<blockquote>
</blockquote>
<p>A terraform code was created for this pods and you can check it <a href="https://github.com/danielrive/blog-posts/blob/main/copy-rds-snapshots" target="_blank" rel="noopener noreferrer">here</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rds-snapshot">RDS Snapshot<a href="https://danielrive-site.github.io/blog/Event-Bridge-Lambda#rds-snapshot" class="hash-link" aria-label="Direct link to RDS Snapshot" title="Direct link to RDS Snapshot">​</a></h2>
<p>You can configure automated RDS snapshots for your instance, this occurs daily during the backup window that you define in the instance creation.
In this case, the automated RDS snapshot was configured in each instance, this just creates the snapshot in the same account and region where the RDS instance was created.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-event-bridge">AWS Event-Bridge<a href="https://danielrive-site.github.io/blog/Event-Bridge-Lambda#aws-event-bridge" class="hash-link" aria-label="Direct link to AWS Event-Bridge" title="Direct link to AWS Event-Bridge">​</a></h2>
<p>EventBridge is a serverless service that uses events to connect application components together, making it easier for you to build scalable event-driven applications. You can use it to route events from sources such as home-grown applications, AWS services, and third-party software to consumer applications across your organization.</p>
<p>In this case, AWS generates a significant number of events for some services, for RDS you can find the events divided into categories, the following table shows the events for RDS snapshots. when RDS starts an automated snapshot, AWS registers that event. You can find all the events in the <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Events.Messages.html" target="_blank" rel="noopener noreferrer">AWS documentation</a>.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/beogf5s4wdgk7wfbb5c3.png" alt="RDS Events" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-the-events">How to use the events?<a href="https://danielrive-site.github.io/blog/Event-Bridge-Lambda#how-to-use-the-events" class="hash-link" aria-label="Direct link to How to use the events?" title="Direct link to How to use the events?">​</a></h3>
<p>Let's start with an important concept in the EventBridge world, An event bus. This a pipeline that receives events, you can configure rules to manipulate the events and specify actions when these came. Events are represented as JSON objects and they all have a similar structure and the same top-level fields. By default, the AWS accounts have a default event bus that receives events from AWS services.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g2qv8j574deuvsbwz4rb.png" alt="default event-bus" class="img_ev3q"></p>
<p>In this case, we can create a rule using the default event-bus.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mmi4m21fibnoe4anq2k5.png" alt="rds-rule-creation" class="img_ev3q"></p>
<p>You can choose the AWS service to use and AWS will show you and JSON with an example of how the event will look.</p>
<p>For our case we can use a simpler event using the EventID for automated snapshots, RDS-EVENT-0091, you can refer to the image shown at the top of the post for more information.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"aws.rds"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"detail-type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"RDS DB Snapshot Event"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"account"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"1234567890"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"region"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"us-east-1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"detail"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token property" style="color:#36acaa">"SourceType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"SNAPSHOT"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"EventID"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"RDS-EVENT-0091"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the event-pattern defined, we can specify the lambda function to execute when this event comes to the default event bus.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0l40u9o0ai1k7xehswu8.png" alt="Trigger-lambda" class="img_ev3q"></p>
<p>This means that if an event is received in the default event bus and matches with the pattern specified, that will trigger the lambda and pass a JSON with the event generated, this looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"844e2571-85d4-695f-b930-0153b71dcb42"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"detail-type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"RDS DB Snapshot Event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"source"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"aws.rds"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"account"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"123456789012"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2018-10-06T12:26:13Z"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"region"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"us-east-1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"resources"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"arn:aws:rds:us-east-1:123456789012:db:mysql-instance-2018-10-06-12-24"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"detail"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"EventCategories"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"creation"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"SourceType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SNAPSHOT"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"SourceArn"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"arn:aws:rds:us-east-1:123456789012:db:mysql-instance-2018-10-06-12-24"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Date"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2018-10-06T12:26:13.882Z"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"SourceIdentifier"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rds:mysql-instance-2018-10-06-12-24"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Message"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Automated snapshot created"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lambda-function">Lambda Function<a href="https://danielrive-site.github.io/blog/Event-Bridge-Lambda#lambda-function" class="hash-link" aria-label="Direct link to Lambda Function" title="Direct link to Lambda Function">​</a></h2>
<p>The lambda function is a python code that gets the events and extracts the useful information and starts a copy in another region.</p>
<p>The lambda functions just start the copy, the function doesn't wait to be completed the task.</p>
<p>You can see the python code <a href="https://github.com/danielrive/blog-posts/blob/main/copy-rds-snapshots/modules/python_code/copy-snapshots.py" target="_blank" rel="noopener noreferrer">here</a></p>]]></content:encoded>
            <category>AWS</category>
        </item>
        <item>
            <title><![CDATA[Trusting in your IaC Terraform Compliance]]></title>
            <link>https://danielrive-site.github.io/blog/terraform-compliance</link>
            <guid>https://danielrive-site.github.io/blog/terraform-compliance</guid>
            <pubDate>Sun, 30 Jan 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[fluent-bit]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" alt="fluent-bit" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAAD7CAYAAACyskd5AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAdHklEQVR4nO3dZ3hUZcKH8f/MpJBeIJQQSCih1yAgINJEVOwNEVBxFRUVdXXZVdzFgu7ae2UXBBV0sSAgrAUQQQUEDJ2QBEJCQklCCKQnM/N+APIyzCQkkOSh3L/r8kPOnDnzMGDuOWeec44lL8vpFAAAqFNW0wMAAOB8RIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAV6mBwCYUFpaqk9mT1doaLiuu/rG8uVr163Whk3xGtB/iFq2aHVK237znVfUpUt3Dew/2O2xhO1b9evK5erdq686tOskSUrZtUOrfl+pgoI8+fsHqlXL1orrdoGsVj4fA+cyS16W02l6EEBdy8s7rMYxwerYvrNWLd9QvvypKU/o5df/qekfzNJNN4w8pW0HNrC4bfeYaTM/1IQ/36OX//WW7r3rAb35ziuaPOVxlZaWlq9js3kpc3e+fLx9Tun1AZwd2AMG6tDQwcP030/nqWP7TiooyNfTz0+SzealN1/5QLGt2+rw4UM6kJNNfIHzAMe4oN0JuXI6OBByoszM/brj7pEaMLSX+gzophtuGa7vf1wkSSopKdakyX9R34HdFdenvYZc3lc//by4/LkFhQV6/e2XdPWNl6p3/y56452XJUkJ27fpo5lTtWXbZmVlZ6q4uFjdusRpzK1jdWGvvho65DKNuHGUJGn//n16+C/j1Xdgd/W+uIvuGj9GiUnbJUmLvl+gm0ddrWXLl+iBR8YpKXm7ps34UGPH3arpM6dq+HVD1HdQnCY/+7jsdnsdv3MAqoIAQz9M365Zz6zTnh2HTA+lzuUeOqg5X31W/t+2hC3lj/n7BygrO1NtYtupffuO+mXlco0ee6Nycw9q7vyv9MY7L8vmZdOA/oMV2SRK3t7e5c/dmZKsyc8+rqTk7dq2fYuemvKEiooKlbp7lxZ+N1+7UlN07CPP8c873ug7b9J/PnpfDRpEKLpZjOZ8OVvX3jxMJSUl2pWaooXfzdfVN16qWZ/PUM7BHG3ZulFzvpqtJyY/psCAQBUXF+mVN/6lufO+qM23EMAp4hA0JDmVuuWgZk5ao84Dm2jAiFYKCD0/DoHuTk/T2HGev+sNCAjQgq9+LP/5ocfu038+el8pu3YoJydbkjR08OWa+Ogk1fOt5/LcyMgoLZq7VC1iWuqqG4Zq2fIlKigoqPK48vIO67dVKxTXvafmffGdJItuv+sWfTn3c23dtrl8vX59+uuNl99XbOu2+nzOJ5Kkj6f9V5cMGqbFS7/XNTcN0+atG3XDdSOq/NoA6gYBRjmH3an1izOUsCpT/a6PUdywKHl5n9sHSVrEtNTUd2eW//yfGR9q9udHfrY77Jo240OtWbtKZWVlWhe/RpLkcDp18UWDFB5WXy++OkX/mfG+Lhk0TM9OfkGRTZpKksJCwtSqZWtJkpdX9f83KykpkdPpVGhIqCSLJCkkOESSVFRcVL7ejdePVGzrti7PDQoMliT5+Bz5EOVwOKr9+gBq37n92xWnpCivVItnJmraxNVKWpslncNfD/v7BejCXv3K/2t6NKCS9P0Pi/TIX8ZrW8IW+fn5uzyvfbuO2rAmSZ9Mn6MLe/XV5198qrffe61ar205GtaSkhJPD7o51b+G0rKyU3wmgNrEHjAqlJ2ery9eXK+W3epryG2xqt80wPSQ6lT6nt2SpLvvHK8rL79GY++5VYlJCZKOTNDan7VfF/UdIJvVpm8XzVNhUdUPMUtSRIOG8vcP0Lr4NXrng9fVumWsDucd1oED2brz9nsUFBSsjZvXa/2GP+Tn56fVa36TxWJR08go/bF+bYXb3ZqwWZFNmmrN2tWSpMCA8+vvDThbEGBUyumUkv/I1q5NOYobFqW+18fIL9DzpKFzTZ9e/eTr66sJj96jRyaOl4+Pb/lj8xfO1YRH75GPj4/sdrtsVpsGXOR+4Y3K+Pn56eV/vqHHHn9If530SPlym9WmO8bcrUkTn9KTT0/URYN7HN0jtui+cRMU1bRZpdt94OG7ZbFY5HQ6FRQYpOuuvqla4wJQN7gQBzT9b6u1d8fhKq0bGOqj/je3VJdBkbLaPBwnPUvY7Xat+HWZAgICdUFcr/LlO1OSlZq2S+3bdlTDho20ectGrYtfoxYxLdW6VRslbN+quO49ZbPatGFTvHamJMvhcKhTxy7q2rm7JGnZ8iUu292wKV45OQfUt09/ZWVlanviNrVu1UZNI6MkHdmbXhe/Rnn5hxUYEKQWLVoptlUbWSwWJSZt17r431VWVqbOHbuqc6euslgsSs/YraTk7WoT205NGkdKkh7724N6/99v65V/vaWQkFBJUt8L+6t5s+i6fGsBVBEBRrUCfEynAU101f0damlEOBXHArx40a/q3bOP6eEAOAkmYeGU5B8sliStXpCqvJziOnnNQ1lFWrMorU5e62xmsZy9RyaA8wkBxmnZvGKvpj66Sqvmp6qspHZOdykttuuXr1I09dFVSliVWSuvcS649+4J2vB7ouK6XWB6KACqgElYOG1FeaVa8nGi1i9J16BRsYq9oEGNbNfplBJW7ddPnyYpZ19hjWzzXNa6VazpIQCoBgKMGpOdXqAvXzpy2tLg0bFq0OzUT3/Zl3JYi2cmatemnBocIepKWVmptm3fqsSk7Tp8KFdWm01hoeGKjo5Ryxat5X/CedXA+YgAo0YdO20pZVOO4i5tqn43tKjWaUv5uSVaMWen4heny2FnfuDZxul06pPZH+nFV59Tyq4dcnqY4xkSEqrv5/+sjh06GxghcOYgwKgV9lKHfv82TVtW7FP/m1uq6+DKT1uylzm07vt0/fLlThUeLq1wvZpSWFSoO8fdWuPbfXziZHXp1K3Gt3u2eO6FyXrhlSkew3tMbu5BNWzYqA5HBZyZCDBqVX5uif43dZviF6dr8JhYRXcMc1tnR3y2lnycpMy0vDobl72sTPMXzq3x7d419r4a3+bZYtPmDXrx1ecqja8kBQeFKKJBwzoaFXDmIsBQ/5tbavGMRB3YU71LKVbH3h2HNfvZP9Sud4QGjmqt0IZ+ys4o0NJPkpS0NlOcjX72+2zOJx5v/ODr66uwsHDZy+w6dPiQWh69SQVwviPAUOu4BorpFK7fF6bqt7m7VFxQOxfvdzqc2vrbfhUX2jXiiW6a//Zm7Uk6/+5BfK5as26127K47j312cyv1bhRE9ntduXn5yn3UK6B0QFnHgIMSZKXj1V9ro1Rp4ubaNnsZG1esbfWJkEdO0TpdLDbey7JzNzntuy2UXeW36LRarUqNDRMoaHuX0MA5yMCDBdB4b668v4O6j60qRbPTFT69nNzbyUgIFDJW/ZU+Pj+zH3qM8B9MtXUd2dq8MChFT4vLDS8RsZ3Njr+PsXHhASFGBgJcHYgwPCoaZsQjX6mh7as2KufZifrcHbdXG6yrlgsFjVq2LjCxyvaOw8NCav0eec1DmgA1UKAUSGr1aJOFzdRbM8IrZy7S78vTFNpsd30sM54paUlSkxOVGJSgg4cyJbD4ZC/v7+im8eoU4cuCg6ueK+wzF6mkpISl2V+9fxcru9cWlqq1WtWql+f/uWvV1r2/9/bWy1W1atXz2Ubhw7lKil5u+K693RZnpefp/T0NO1OT1NWdqby8/PkdEo+Pj6KaNBQrVvFKia6pby83H9VOBwOl71eh9N9AlZxSbEKCl0n93nZvOTj4+Pxz5+VnaVtCZuVtjtVBQUFslgsCg0JVUxMS7Vt014B/hVf3MVut6u4xPWDYnXfOx9vb3l5uZ637nA4tHffHiXvSNLu9FQVFhaoSZOmuqjPxQoKCvY4ltzcg0remaRdqSnKyTmggIAA9e7ZRzHRLSscP84/BBgn5evnpQEjW6nLoEgt/SRR23/PMj2kM1LOwQN6451XNOuzGdqzN8Pj6TiBgYG6dMjlmvTXp9W2TXu3xxd8O1f3P3yXy7Jflq5TTHRLHc47rOkzP9S/p7+ntN2pyk4vktVq1dPPPanpMz8sXz8iopHiVyVIkvbszdBb776qT2ZPV8cOXbTom6WSpCefmqhlK5YqKSlBh/MqvhOWxWJRs6jmuuWmMXr4gcdcPjxs2rJBl189sPxnT9t5ZOL9+uukh12WjbhxlF598Z3ynx0OhxZ9v0Bvvfuqfl+7SsUeDmVLRy7gMeySK/TIgxPVuVNXt8f/98O3Gjf+Npdly35Yrdat2qigIF8fz5qu96a+peQdicpMK1C9evX0/EvP6MN/v12+/qiRd+jF515XUXGRlv28WPMWfK1lK5YqbXeq7HbXyYkN6kfog7c/0rChV8jpdGrzlo366ps5+nHJ/7Q1YYsKT/jg4e3trfvunqBnn3pBNqvN458R5xcCjCoLa+yn6x/ropSNB7QjPtv0cM4oGzbFa8Toa5W2e1el6+Xl5emrb+bo+x8Xaeq7H+uq4de6PF5aWuo2S3hbwlb9unKFnn5uktIzdpcvz8zar0YNG6uoqNDlOYcOH9L+zH364N/v6J33X1Ne/pHzqzP2pJevs/C7+dqeuO2kfy6n06nUtF168dUp+mbBl/r2qx/V+Oj9h+12+0lnNBcWFqjwhMt4+x63d55fkK/7Hhyrr+d9cdLzh3NzD+q/X87S1/O+0N8ff0aPPDjRbe/2xPEkbN+qNetW65nn/67UtJTy5Xv37VFMdAsVFxW5PGfegq8UHlZf02Z84PJ+eZKVnanb7hqhl55/QzM/nabVa37zeBrW8eN7891X1KxZc91394RKt43zAwFGtcV0DldMpyOTjWxedXtDLZvXmXervf2Z+3T9iCu0d1/Fk7pOlJefpz/dN1q/Ll2n1q3aVLru/Y/cpX379rotz8hI9/h9tNPpVL9BcdqzN8N1/eOC0ja2XZUCfLyE7Vv1wCPj9MXsBdV63omOTVRzOp265/7bNXf+l9V6fmlpiSY/+7iCg0J019h7K133ocfu8/j3sndfhmKiW7gt352epin/+keVx5Kfn6fxD/2pyutL0qtvvqh7/vSArFZuRne+418ATs3RDl73587qMrBJpZeZrAlWm0VxlzbVVQ92rNXXORUvvjLF4y95i8WiBvUbqFlUtAIDAt0eLyjI1z9feuak2/cUX0lK37Pb43JJbvGVjuyN5hw8IEkuh7+tFqsCAwJVP7yBGkY0UlhYuMfvfCXpux8XVjvcJwo7ehrSwu/mVxpfb29v2Wyex+F0OvXk0xO138OpT8er6EPR3r1V/7BU0/bsSVdC4lZjr48zB3vAOC0lRXYNH99B3YdGafHMRO1OOFjjrxHdKUxDxsSqUYugGt/26SouLtann890W94mtp0+eGu6unXtIW9vbx06lKup09/TU1OecDnUOu/br1VYVCi/en7Vet0e3XuqebPoKq9vs9k07JIrZD363eNVw69TTHRLtWvbQc2bRSsoKFi+vr6yWW0qKytVZlam/vPR+3rpteddtuN0OrVk2Y9qE9tO7dt20OrlG8sfu+amYW7hnzL5BV16yRUuyyIjoyRJU6e96zZOq9Wm8eMmaNQttyuySVM5HA4lJG7VW++9pm8XfeOybl7eYX0+51M9OP7PVX4fJKl71x6K9rD3W5HIJk3VpXN3+Xh7a8myH5VXyXfmkhQUFKz2bTuoWVRz/bF+rXbsTHZbZ8fOZLVve+Z9mETdIsA4LfPf3qzQhn4adGsrjXo6Tlt/2aefZifrUJbniTTVEdrQT4NGt1bb3hEu3/WdSdZvWKfDh92v5jXt/U/VrWtc+c/BwSF69KG/6bsfFurXlcvLlxcWFmjjxnj16tmnSq/XoX0nTX5iii679ErZbCefyGOxWDR0yGWaNPEp9YjrVb68R/ee6nHCjOhjbDabopo20+RJz2nJsh+19oQrXCUlb5ck1avnpw7tO5Uv9/F2n9ncNLKZyzrHlJaWaPkvy9yWP/zgX/TM3//psiwioqH6XniRhl93iZb/8pPLY0uW/VDlALdr20H/ePxZDb/8mpO+dyHBIRpx02iNvHn0kQ9RR2dGfzbnE9113xi39b29vXXFZVdrzK1jdVGfixUYeOTD4sHcHLXpFOU2E7wgP79KY8a5jQDjtDgdTm39dZ+S1mWp91XN1fvKaMVe0EAr56Vq9YLUUzptycfPpguvjlavK5vL2/fMni26I8V97yaiQUOX+B6vd88+LgGWpF1pKScNcFhomJ782zO68/Zx8vYQOk9iW7fVC1Ne09Ahl53yB5iO7Tu7Bfhg7unfozk1bZfH2c5jRt7hcX2r1abRI+9wC3BVDoeHhoTpiYmT9aex98rXx/ek63fvdoG+mfOdwsPcL6riaea6dGS2tae7YIWGhCmiQUPtOm4CGHAMAUaNKC2ya8Wcndr40x4NvLW1+t/UQp0HNtFPnyYpYdX+Kt1swWK1qEO/Rho4spWCG9Q7+RPOAIc87P2GhIRWuL6fhxvRn2wmcf3wBlq5LF5Njl7SsSr69umvuZ8vkn8l581WhZeHPUW7/fTPBc856DniTY8envYkqmkzt2UHcyv/yiMkOEQrf17v8bkVadyoicf4VqZdmw7VWh+QCDBqWG5mkb55Y5PWfR+qIbfF6ro/d1bKpgNaMjNJ+1Iq/u4sMjZYQ8bEKqpdxfE6E3k67SQ9Y7cuv2aQx/VTPewJlZVVfvOLgIDAasVXOhKy041vbTrxnNpjTrwIxvE8zRo+2YcBP/+AasUXqEsEGLUibetBzXxyjboMbKL+I1rp9ud7asPSDP38+Q6X9QLDfTVgREt1urj2Z1LXlcLCArdDpWeivLw8fbPgS/226hdl7NmtoqJCt3USk7YbGBlwfiDAqDUOu1PxizO0beV+9buhheKGRandhQ21Y/2Ri3j0GBaltr0byteff4Z1bf3GPzTytuuUmlb5hUMA1B5+86HWFeWXafHMRMUvztDgMa3Vod+Ri0d0GRRpeGTnp6KiIt16+/XEFzCMAKPOZKfna86/1uuCy5tp6NjKr/50NmtQP0KPTJhY5fX79O5Xi6Nxt2DRN9qVmuK23Gq1ql49P1mPmzFdXFys0rLSOhwdcP4gwKhz2RnnzjmQnk7vCQ4O0UP3P2ZgNFWz+vdf3ZZ179pD0z+cpYYRjWQ5brLTpMmPadqMD93WP10VXeGqtLS0wjsl2e3uE964nCPOZgQYOA3Bge5X58o9yakxpu31cGnLETeO8nhN6nq+tXM6WEWn+exK3enxwh2S5xnkxy5rCZyN+PgInAZPlzTMPpClP9avNTCaqnE43E/dsVVw7efKTgs6Hc2aRXs8J/rfH73v8a5IJSUl+ujjqW7LY1u1rZXxAXWBAAOnoVvXHqrn4TrOt991i777YaFyDh5QcXGxiouLdOhQrtJ2p2rpsh/12psv6oZbhuuruf+t8zHXrx/htuzbRd+o8Oh9A51Op/bt36tpMz7U1/Pm1MoYvL28NejiIW7Lp057V/c8cIeWLV+qlF07lLwjUfO//VrX3DRMq9esdFt/8KChtTI+oC5wCBo4Df5+/rr+2ps167MZLst37EzSDSOHy9e3ngIDAuR0SkXFhSosLHTZw2vZorWuv/bmOh1zty7ul8n86efF6tA9Rs2imivn4AGlZ6SrpKS4Vsdx37gJWvT9Apf3w+l0atbnMzXLww0uThQcFKxRI26vzSECtYo9YOA0/ePxZ1Q/vL7Hx4qLi5R9IFsHcrJVUFDgdnh1bfzvdTFEF1defo38/d0P/2Zm7de6+DXambKj1uMrSYMGXKLRFVz7+WQsFoteeO511a/foGYHBdQhAgycpqimzTV3zneKrOblIiVpw8b4k16KsqZFRDTUpL8+XaUbNPSI6yVvb9fvga01eGeq119+T3fePq5as5n96vnp5X++qTG3jq2xcQAmcAgap6XHZc209JNEFRw6t84VtVitqh/uvnflXcEpMt279tDKnzfo/alv6b9fztLOlGSP1ym2WCwKDgpWu7YddPFFg3T5sKtcbo3n4+vr9ronm+kbEBDo9pyggMrvnTxh/KPy8fHVCy8/q6zsTJfH/P381efCi/SnO+7V8Muu0g0jr9If8WvKHw8N9TyDOTQ0THn5eS7LfHwrv/uQr4+v3nzlA424cbTe/eB1LVu+1OPdliwWixo3aqIrLrtaD9z7sGJbu0++8vXxqfZ75+8f4P7eBVX83nnZvDz+u1Aln0lO5X3B+cGSl1WV+9QAFSs4VKoVX+xQ/OIM2Uvdz9U8UYuu4bplUvc6GNnp8XTDAKvVdtI9R4fDoT170rVz105lZ2fK7rDLZvNSeFi4mkZGqXHjSPl7mAEsHfkO1H2WsqXS+9c6HA45na7vu8VikdV68ls55uXnKX79OmVk7Ja3j7eaRkapTWx7hR53R6cTt2+xWCu5MYLrr5OqvF/HKygs0M6dydqdkab8/DxZLBaFBIcqJrqFmkVFu+2NH68u3jvPr1Hxec1SzbwvODcRYNSY/al5WvJxonauP1DpemdLgAGgNvEdMGpMw+aBGvFEd93wly4Kb+J5Dw8AcATfAaNGWSxSm54Ratm1vtYsStOvX6eouKBuJxkBwNmAPWDUCi8fqy68Jlp3v3qhugxsIquV77sA4HgEGLUqKNxXw8d30OhneiiqbYjp4QDAGYNJWKgzTodTm1fsU+qWHF1xb3vTwwEAowgw6pzT4ZSFQ9IAznMcgkadI74AQIABADCCAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABhBgAAAMIMAAABhAgAEAMIAAAwBgAAEGAMAAAgwAgAEEGAAAAwgwAAAGEGAAAAwgwAAAGECAAQAwgAADAGAAAQYAwAACDACAAQQYAAADCDAAAAYQYAAADCDAAAAYQIABADCAAAMAYAABBgDAAAIMAIABBBgAAAMIMAAABvwfkQznTDgGbXsAAAAASUVORK5CYII=" width="480" height="251" class="img_ev3q"></p>
<p>Infrastructure as Code has started to be an important part of our cloud journey, giving us the ability to automate deploys and replicate our infra in multiple environments and accounts. Using code to define our infra allow us to implement some practices from developers world, like testing, version control, etc.</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8rz6ct19c0b7xr5ulfo5.jpeg" alt="IaC power" class="img_ev3q"></p>
<p>As a lot of tools, IaC can introduce bugs or maybe miss configurations that then can be our headache when errors arise, or maybe audit companies come to review the security of our infra.</p>
<p>IaC has enabled us to implement development practices like generating Pull Request with the new changes, this is very important when we want the revision from other coworkers, frameworks to do testing and maybe IaC tools that use common language programing help us to validate our infra-code, but this is more for technical teams and translate this to non-technical languages can be complicated, limiting the scope for the revision. Here is when terraform-compliance framework appears to help us to define rules to validate our infra and define if accomplish with the requirements defined from the technical side and business side.</p>
<p>Terraform-compliance is a framework that validates the compliance in our infrastructure defined by terraform, this is based on negative testing and BDD that work together to validate our infra. This post will show how to implement this framework and add it to our DevOps pipeline used to deploy our IaC, AWS will be used as a cloud provider.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="https://danielrive-site.github.io/blog/terraform-compliance#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3>
<p>Terraform-compliance validates the code before it is deployed, we can install it using docker or via pip. In this post, we will use pip.</p>
<ul>
<li>Python</li>
<li>terraform 0.12+</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-this-work">How does this work?<a href="https://danielrive-site.github.io/blog/terraform-compliance#how-does-this-work" class="hash-link" aria-label="Direct link to How does this work?" title="Direct link to How does this work?">​</a></h3>
<p>Terraform-compliance uses policies that define the features that the infrastructure must-have, like encryption enabled in the buckets, resources well tagged, etc. These policies are executed against the plan that Terraform generates and are defined using  <strong>Behaviour Driven Development(BDD)</strong> Principles, that use English like the language to define the policies.</p>
<p>To work with terraform we need to create a file in which the policies are defined, using BDD principles that file is named feature and contain the scenario that we want to evaluate.
The structure of the file is the following:</p>
<p><strong>Feature:</strong> A summary about the things to validate
<strong>Scenario/scenario Outline</strong>: define the test to execute, this includes BDD directives like:
<strong>GIVEN:</strong> It is used to define a context that can be a list of resources or data that we want to check, we can see this as a filter.
<strong>WHEN:</strong> filter the context defined above, for instance, if the context defined says that will evaluate all the s3 buckets, with WHEN we can filter by tags for instance. If the condition doesn't pass this just skip to the next line instead of fail.
<strong>THEN:</strong> Has a similar function that WHEN but if the condition doesn't pass the scenario will fail.
<strong>AND:</strong> It is used to define an extra condition to our scenario, this is an optional statement.</p>
<p>Here and example to evaluate if all the resources has tag defined.</p>
<p><code>Scenario: Ensure all resources have tags       Given I have resource that supports tags defined       Then it must contain tags       And its value must not be null</code></p>
<p>Each BDD directive has more capabilities and can be checked in <a href="https://terraform-compliance.com/pages/bdd-references/" target="_blank" rel="noopener noreferrer">Terraform-compliance documentation</a>.</p>
<p>The Feature file is executed against terraform plan, to do this terraform-compliance needs the TF plan as an input, for that we need to save our plan in an external file and pass it to terraform-compliance command that we will see later.</p>
<p>With the basic explanation made above let's make and example.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hands-on">Hands on<a href="https://danielrive-site.github.io/blog/terraform-compliance#hands-on" class="hash-link" aria-label="Direct link to Hands on" title="Direct link to Hands on">​</a></h3>
<p>This post was part of a webinar made in my current company and a Github repository was created, <a href="https://github.com/danielrive/epam-devops-webinar-2022" target="_blank" rel="noopener noreferrer">here is the link</a>.This repo contains a few AWS resources defined by terraform and uses Github actions to execute with each push the terraform-compliance framework. All the stuff that we will execute is before the terraform apply so we don't spend money creating resources</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wbq72iwj2excg6dmju9a.png" alt="dev meme2" class="img_ev3q">.</p>
<p>The project has been divided into two parts, the first one contains the terraform code to deploy the infrastructure and is located in the root of the repo, the second part is a folder named compliance that contains some files with .feature extension and defines the rules that we want to evaluate against our TF plan.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#### Data Sources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "aws_caller_identity" "ID_CURRENT_ACCOUNT" {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">###  KMS Policy </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "aws_iam_policy_document" "kms_policy" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sid    = "Enable IAM User Permissions"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect = "Allow"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type        = "AWS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      identifiers = ["arn:aws:iam::${data.aws_caller_identity.ID_CURRENT_ACCOUNT.account_id}:root"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources = ["*"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##########################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Secret manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># KMS ky to encrypt at rest secret manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "kms_secret_manager" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = "./modules/kms"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME   = "KMS-SecretManager-${var.environment}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  POLICY = data.aws_iam_policy_document.kms_policy.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "secret_manager" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source    = "./modules/secret_manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME      = "secret_${var.environment}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RETENTION = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMS_KEY   = module.kms_secret_manager.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "secret_manager_k8" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source    = "./modules/secret_manager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME      = "secret_k8_${var.environment}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RETENTION = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMS_KEY   = module.kms_secret_manager.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_s3_bucket" "bucket_test" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = "my-bucket-forcompliance-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_side_encryption_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /*   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sse_algorithm = "AES256"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kms_master_key_id = module.kms_secret_manager.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sse_algorithm     = "aws:kms"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name        = "bucket_${var.environment}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = "develop"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = "DanielR"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_s3_bucket" "bucket_test2" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = "my-bucket-forcompliance-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_side_encryption_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kms_master_key_id = module.kms_secret_manager.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sse_algorithm     = "aws:kms"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name        = "bucket_${var.environment}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = "develop"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = "DanielR"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_secretsmanager_secret" "secret_manager2" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                    = "test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  recovery_window_in_days = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_before_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name        = "test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = "develop"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = "DanielR"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Terraform code creates KMS key, Secret managers that are encrypted by KMS and s3 buckets with SSE with KMS.</p>
<p>Compliance folder has three files and each one define a scenario, let's move on with the <em>S3.feature</em> file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Feature:  This validates if the s3 buckets has Encryption enabled using KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scenario: Ensure that s3 buckets are encrypted by KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Given I have aws_s3_bucket resource configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    When it contain server_side_encryption_configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Then it must have apply_server_side_encryption_by_default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Then it must have sse_algorithm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    And its value must be "aws:kms"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With that file TF-Compliance framework will validate if the S3 buckets created with that TF code have Server-Side-Encryption enabled but using KMS key, here a quick explanation of the file:</p>
<ul>
<li><strong>Given</strong> statement define the context in this case, all the resources defined by <strong><em>aws_s3_bucket</em></strong></li>
<li><strong>When</strong> statement makes more small the context, in this case TF-compliance will check the buckets that have server_side_encryption_configuration in their definition.</li>
<li>We have two <strong>Then</strong> statement and are used to defined that the buckets must to have <strong><em>apply_server_side_encryption_by_default</em></strong> and the <strong><em>sse_algorithm</em></strong> must be <strong><em>aws:kms</em></strong>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-commands">Running the commands<a href="https://danielrive-site.github.io/blog/terraform-compliance#running-the-commands" class="hash-link" aria-label="Direct link to Running the commands" title="Direct link to Running the commands">​</a></h3>
<p>As we mentioned before, we are using Github actions to run the TF-compliance command, the idea is to validate automatically if the rules are accomplished before the plan if so, the pipe will allow the TF apply command and the infra will comply with the rules defined.</p>
<p>To do that, we need to generate the terraform plan, this must be stored in a file in the same directory, then that will be an input for our TF-compliance command.</p>
<p>To do that we can run:</p>
<div class="language-HCL language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan -out=plan.out </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>plan.out is the name of the file to create, we can put any another name.</p>
<p>Once the plan is created we can go ahead with the execution of the TF-Compliance command, here is the command to do the magic</p>
<div class="language-HCL language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform-compliance -f compliance/ -p plan.out</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the -f flag we specify the folder in which we are storing the rules(.features files).</p>
<p>The output will be</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2wmg3xm80f9qx51r3umv.png" alt="output-ok" class="img_ev3q">.</p>
<p>Let's change the code to use the default algorithm to encrypt  the s3 buckets.</p>
<div class="language-HCL language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource "aws_s3_bucket" "bucket_test" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = "my-bucket-forcompliance-test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_side_encryption_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply_server_side_encryption_by_default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sse_algorithm = "AES256"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Running again the TF-compliance command will be:</p>
<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5agyq3v0vf2keiky62x2.png" alt="output-failing" class="img_ev3q">.</p>
<p>With this we can validate how the framework works, we can define multiple rules and these can be checked for all the teams because are not 100% technical.</p>]]></content:encoded>
            <category>AWS</category>
        </item>
        <item>
            <title><![CDATA[Sharing secrets to ECS in an AWS multi-account architecture]]></title>
            <link>https://danielrive-site.github.io/blog/aws-secret-manager</link>
            <guid>https://danielrive-site.github.io/blog/aws-secret-manager</guid>
            <pubDate>Mon, 15 Feb 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[Alt Text]]></description>
            <content:encoded><![CDATA[<p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/i/hc1ewvgl19l0b0yeqser.png" alt="Alt Text" class="img_ev3q"></p>
<p>In this post, We'll see the highlight steps on how to share secrets between AWS account using  ECS Fargate that get the secrets stored in AWS Secret manager but in a different account. We'll use Terraform to build this.</p>
<p>When We are developing our application the best practice to pass secret inside our code is to use environment variables, Secret Manager is a great option to store our variables, We can rotate them and has direct integration with some AWS services like RDS and Redshift.</p>
<p>On another side AWS Multi-account architecture can be a good election if We want to separate some resources and maintain isolated environments, AWS provides us different ways to achieve that, being AWS control tower a good way to create and government multi-account architectures. The following image shows an AWS multi-account architecture with three accounts, Production, Develop, and Security, the last one can be used to store our environment variables, and there We can define strong policies to limit the access to the resources.</p>
<p>Previous image shows the architecture that We'll use, you can find the terraform code in this <a href="https://github.com/danielrive/aws-ecs-iac" target="_blank" rel="noopener noreferrer">Link</a>. A Secret Manager will be created in the Security account, this secret is encrypted using a custom KMS Key, We can't use the default KMS key because that is managed by AWS, and We can not control it and modify its policy. ECS task will use an IAM role with the correct permissions to get secrets from the Security account and put them into the container.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-code">Terraform Code<a href="https://danielrive-site.github.io/blog/aws-secret-manager#terraform-code" class="hash-link" aria-label="Direct link to Terraform Code" title="Direct link to Terraform Code">​</a></h2>
<p>The Terraform code is using Modules stored in the same repo, and use AWS profiles(.aws/credentials) to get the credentials to create resources, in this case, We have two profiles, the first one for a Develop Account and the second one for a Security account. To specify the profiles you must set the names in two terraform variables.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider "aws" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  profile = var.PROFILE_NAME1 # profile name for dev account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider "aws" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  profile = var.PROFILE_NAME2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alias   = "Security_Account"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="steps">Steps<a href="https://danielrive-site.github.io/blog/aws-secret-manager#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps">​</a></h2>
<p><strong>1. Create IAM Roles - Develop Account</strong>
The first resource that We need to create is the IAM Role that the containers will use, this role must have permissions to get secrets and use the KMS to decrypt the secret. This role must be created in the account in which you'll create the ECS resources. Go to <a href="https://github.com/danielrive/aws-ecs-iac" target="_blank" rel="noopener noreferrer">GitHub</a> repo to see in detail the Modules.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Module to create an IAM ROLE for ECS Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "ECS_ROLE" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source          = "./Modules/IAM"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE_ECS_ROLE = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME            = "ECS-Role-TASK"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2. Create KMS key - - Security Account</strong>
Once you have the ECS role and its ARN you can create the KMS key, this key must be created in the security account and the policy should allow to ECS role created in Step 1 to describe and decrypt the key.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># KMS POLICY for the Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "aws_iam_policy_document" "KMS_POLICY" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sid    = "AllowUseOfTheKey"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect = "Allow"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type        = "AWS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      identifiers = [module.ECS_ROLE.ARN_ROLE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "kms:Decrypt",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "kms:DescribeKey",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources = ["*"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>How this resource must be created in the Security account We need to specify the provider when We call the Terraform Module.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a KMS Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "KMS_SECRET_MANAGER" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = "./Modules/KMS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME   = "KMS-key-SecretManager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  providers = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws = aws.Security_Account   # alias for security account defined in the first lines of this code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  POLICY = data.aws_iam_policy_document.KMS_POLICY.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3. Create Secret Manager - Security Account</strong>
With the KMS Key ready We can continue with the Secret Manager creation, for this case, We'll attach to the secret manager a resource-based policy to allow access to ECS role created in the Develop account.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Resource based policy for Secret Manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data "aws_iam_policy_document" "SECRET_MANAGER_POLICY" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sid    = "AllowUseSecrerManager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect = "Allow"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "secretsmanager:*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type        = "AWS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      identifiers = [module.ECS_ROLE.ARN_ROLE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources = ["*"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Module to create a Secret Manager with a resource based policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "SECRET_MANAGER" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source    = "./Modules/SecretManager"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME      = "SECRET_MANAGER_TEST1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RETENTION = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMS_KEY   = module.KMS_SECRET_MANAGER.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  POLICY    = data.aws_iam_policy_document.SECRET_MANAGER_POLICY.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>4. Create ECS resources and ALB - Develop Account</strong>
The last step is to create the ECS resources and the ALB.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a Task Definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "ECS_TASK_DEFINITION" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on     = [module.SECRET_MANAGER]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source         = "./Modules/ECS/TaskDefinition"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME           = "test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ARN_ROLE       = module.ECS_ROLE.ARN_ROLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CPU            = 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MEMORY         = "1024"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DOCKER_REPO    = "alpine"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  REGION         = "us-west-2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SECRET_ARN     = module.SECRET_MANAGER.SECRET_ARN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CONTAINER_PORT = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a Target Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module "TARGET_GROUP" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source              = "./Modules/ALB"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE_TARGET_GROUP = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME                = "testing"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PORT                = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PROTOCOL            = "HTTP"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  VPC                 = "vpc-0dfa4368a6f7bf90d"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TG_TYPE             = "ip"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HEALTH_CHECK_PATH   = "/"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HEALTH_CHECK_PORT   = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Task Definition is responsible to define the secret manager to use. If We go through terraform code for Task Definition We can see that in the container definition section We specify the secret manager ARN.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">"secrets": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             "name" : "VARIABLE_TESTING",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             "valueFrom" :  ${var.SECRET_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We need to keep in mind that ECS will get the full secrets stored in the secret manager(key/value) into the variable that you specify, in this case, <em>VARIABLE_TESTING</em>(feel free to change the name), which means that the <em>VARIABLE_TESTING</em> will contain the full secrets in plaintext.</p>
<p>for instance, suppose We have three secrets in Secret Manager
<img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/i/3qsw767bqbpfap56k93y.png" alt="Alt Text" class="img_ev3q"></p>
<p>in plaintext</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "endpoint": "www.testingecs.com",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "pass": "1234567",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "token": "34asda3asdas4q34"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>According to the above mentioned the variable <em>VARIABLE_TESTING</em> will contain the plaintext representation and if We run <code>echo $VARIABLE_TESTING</code> inside the container We will get the plaintext representation.</p>
<p>To extract the secrets from <em>VARIABLE_TESTING</em> We can implement a bash script and run it as Entrypoint.</p>
<p>With the steps showed above We can get secrets stored in another AWS account, which helps us to limit the access and create a special policy for the security account with the permissions necessary for users and AWS services.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://danielrive-site.github.io/blog/aws-secret-manager#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h3>
<ul>
<li>
<p><a href="https://aws.amazon.com/es/premiumsupport/knowledge-center/secrets-manager-share-between-accounts/" target="_blank" rel="noopener noreferrer">AWS documentation 1</a></p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html" target="_blank" rel="noopener noreferrer">AWS documentation 2</a></p>
</li>
</ul>]]></content:encoded>
            <category>AWS</category>
        </item>
    </channel>
</rss>