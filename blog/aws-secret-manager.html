<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Sharing secrets to ECS in an AWS multi-account architecture | Daniel Rivera</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://danielrive-site.github.io/img/site-logo.jpg"><meta data-rh="true" name="twitter:image" content="https://danielrive-site.github.io/img/site-logo.jpg"><meta data-rh="true" property="og:url" content="https://danielrive-site.github.io/blog/aws-secret-manager"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Sharing secrets to ECS in an AWS multi-account architecture | Daniel Rivera"><meta data-rh="true" name="description" content="Alt Text"><meta data-rh="true" property="og:description" content="Alt Text"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-02-15T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/danielrive"><meta data-rh="true" property="article:tag" content="AWS"><link data-rh="true" rel="icon" href="/img/cloud-icon1-554344964.png"><link data-rh="true" rel="canonical" href="https://danielrive-site.github.io/blog/aws-secret-manager"><link data-rh="true" rel="alternate" href="https://danielrive-site.github.io/blog/aws-secret-manager" hreflang="en"><link data-rh="true" rel="alternate" href="https://danielrive-site.github.io/blog/aws-secret-manager" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://danielrive-site.github.io/blog/aws-secret-manager","mainEntityOfPage":"https://danielrive-site.github.io/blog/aws-secret-manager","url":"https://danielrive-site.github.io/blog/aws-secret-manager","headline":"Sharing secrets to ECS in an AWS multi-account architecture","name":"Sharing secrets to ECS in an AWS multi-account architecture","description":"Alt Text","datePublished":"2021-02-15T00:00:00.000Z","author":{"@type":"Person","name":"Daniel German Rivera","description":"Cloud Engineer","url":"https://github.com/danielrive"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://danielrive-site.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Daniel Rivera RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Daniel Rivera Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ce37c9a8.css">
<script src="/assets/js/runtime~main.eb81f73a.js" defer="defer"></script>
<script src="/assets/js/main.4ff552c4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/site-logo.jpg" alt="site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/site-logo.jpg" alt="site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Daniel Rivera</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/danielrive" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/eks-fluentbit">Configuring Logging in AWS EKS Using Fluent Bit and CloudWatch</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/terraform-gitops">Using Terraform to push files to Git Repo for GitOps</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/EKS-Prometheus">Adding monitoring to EKS using Prometheus operator</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/fluxcd">GitOps with FluxCD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/github-actions">AWS Infrastructure Terraform and GitHub Actions</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Sharing secrets to ECS in an AWS multi-account architecture</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-02-15T00:00:00.000Z">February 15, 2021</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/danielrivera"><span class="authorName_yefp">Daniel German Rivera</span></a></div><small class="authorTitle_nd0D" title="Cloud Engineer">Cloud Engineer</small><div class="authorSocials_rSDt"><a href="https://github.com/danielrive" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://www.linkedin.com/in/danielrive/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg width="1em" height="1em" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" class="authorSocialLink_owbf"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453" fill="#0A66C2"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p><img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/i/hc1ewvgl19l0b0yeqser.png" alt="Alt Text" class="img_ev3q"></p>
<p>In this post, We&#x27;ll see the highlight steps on how to share secrets between AWS account using  ECS Fargate that get the secrets stored in AWS Secret manager but in a different account. We&#x27;ll use Terraform to build this.</p>
<p>When We are developing our application the best practice to pass secret inside our code is to use environment variables, Secret Manager is a great option to store our variables, We can rotate them and has direct integration with some AWS services like RDS and Redshift.</p>
<p>On another side AWS Multi-account architecture can be a good election if We want to separate some resources and maintain isolated environments, AWS provides us different ways to achieve that, being AWS control tower a good way to create and government multi-account architectures. The following image shows an AWS multi-account architecture with three accounts, Production, Develop, and Security, the last one can be used to store our environment variables, and there We can define strong policies to limit the access to the resources.</p>
<p>Previous image shows the architecture that We&#x27;ll use, you can find the terraform code in this <a href="https://github.com/danielrive/aws-ecs-iac" target="_blank" rel="noopener noreferrer">Link</a>. A Secret Manager will be created in the Security account, this secret is encrypted using a custom KMS Key, We can&#x27;t use the default KMS key because that is managed by AWS, and We can not control it and modify its policy. ECS task will use an IAM role with the correct permissions to get secrets from the Security account and put them into the container.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-code">Terraform Code<a href="#terraform-code" class="hash-link" aria-label="Direct link to Terraform Code" title="Direct link to Terraform Code">​</a></h2>
<p>The Terraform code is using Modules stored in the same repo, and use AWS profiles(.aws/credentials) to get the credentials to create resources, in this case, We have two profiles, the first one for a Develop Account and the second one for a Security account. To specify the profiles you must set the names in two terraform variables.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  profile = var.PROFILE_NAME1 # profile name for dev account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  profile = var.PROFILE_NAME2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alias   = &quot;Security_Account&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="steps">Steps<a href="#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps">​</a></h2>
<p><strong>1. Create IAM Roles - Develop Account</strong>
The first resource that We need to create is the IAM Role that the containers will use, this role must have permissions to get secrets and use the KMS to decrypt the secret. This role must be created in the account in which you&#x27;ll create the ECS resources. Go to <a href="https://github.com/danielrive/aws-ecs-iac" target="_blank" rel="noopener noreferrer">GitHub</a> repo to see in detail the Modules.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Module to create an IAM ROLE for ECS Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;ECS_ROLE&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source          = &quot;./Modules/IAM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE_ECS_ROLE = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME            = &quot;ECS-Role-TASK&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2. Create KMS key - - Security Account</strong>
Once you have the ECS role and its ARN you can create the KMS key, this key must be created in the security account and the policy should allow to ECS role created in Step 1 to describe and decrypt the key.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># KMS POLICY for the Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;KMS_POLICY&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sid    = &quot;AllowUseOfTheKey&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type        = &quot;AWS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      identifiers = [module.ECS_ROLE.ARN_ROLE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;kms:Decrypt&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;kms:DescribeKey&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>How this resource must be created in the Security account We need to specify the provider when We call the Terraform Module.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a KMS Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;KMS_SECRET_MANAGER&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./Modules/KMS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME   = &quot;KMS-key-SecretManager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  providers = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws = aws.Security_Account   # alias for security account defined in the first lines of this code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  POLICY = data.aws_iam_policy_document.KMS_POLICY.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3. Create Secret Manager - Security Account</strong>
With the KMS Key ready We can continue with the Secret Manager creation, for this case, We&#x27;ll attach to the secret manager a resource-based policy to allow access to ECS role created in the Develop account.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Resource based policy for Secret Manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;SECRET_MANAGER_POLICY&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sid    = &quot;AllowUseSecrerManager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    effect = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;secretsmanager:*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type        = &quot;AWS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      identifiers = [module.ECS_ROLE.ARN_ROLE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Module to create a Secret Manager with a resource based policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;SECRET_MANAGER&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source    = &quot;./Modules/SecretManager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME      = &quot;SECRET_MANAGER_TEST1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RETENTION = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KMS_KEY   = module.KMS_SECRET_MANAGER.ARN_KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  POLICY    = data.aws_iam_policy_document.SECRET_MANAGER_POLICY.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>4. Create ECS resources and ALB - Develop Account</strong>
The last step is to create the ECS resources and the ALB.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a Task Definition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;ECS_TASK_DEFINITION&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on     = [module.SECRET_MANAGER]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source         = &quot;./Modules/ECS/TaskDefinition&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME           = &quot;test&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ARN_ROLE       = module.ECS_ROLE.ARN_ROLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CPU            = 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MEMORY         = &quot;1024&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DOCKER_REPO    = &quot;alpine&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  REGION         = &quot;us-west-2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SECRET_ARN     = module.SECRET_MANAGER.SECRET_ARN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CONTAINER_PORT = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Module to create a Target Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;TARGET_GROUP&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source              = &quot;./Modules/ALB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE_TARGET_GROUP = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NAME                = &quot;testing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PORT                = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PROTOCOL            = &quot;HTTP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  VPC                 = &quot;vpc-0dfa4368a6f7bf90d&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TG_TYPE             = &quot;ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HEALTH_CHECK_PATH   = &quot;/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HEALTH_CHECK_PORT   = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Task Definition is responsible to define the secret manager to use. If We go through terraform code for Task Definition We can see that in the container definition section We specify the secret manager ARN.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;secrets&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             &quot;name&quot; : &quot;VARIABLE_TESTING&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             &quot;valueFrom&quot; :  ${var.SECRET_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We need to keep in mind that ECS will get the full secrets stored in the secret manager(key/value) into the variable that you specify, in this case, <em>VARIABLE_TESTING</em>(feel free to change the name), which means that the <em>VARIABLE_TESTING</em> will contain the full secrets in plaintext.</p>
<p>for instance, suppose We have three secrets in Secret Manager
<img decoding="async" loading="lazy" src="https://dev-to-uploads.s3.amazonaws.com/i/3qsw767bqbpfap56k93y.png" alt="Alt Text" class="img_ev3q"></p>
<p>in plaintext</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;endpoint&quot;: &quot;www.testingecs.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;pass&quot;: &quot;1234567&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;token&quot;: &quot;34asda3asdas4q34&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>According to the above mentioned the variable <em>VARIABLE_TESTING</em> will contain the plaintext representation and if We run <code>echo $VARIABLE_TESTING</code> inside the container We will get the plaintext representation.</p>
<p>To extract the secrets from <em>VARIABLE_TESTING</em> We can implement a bash script and run it as Entrypoint.</p>
<p>With the steps showed above We can get secrets stored in another AWS account, which helps us to limit the access and create a special policy for the security account with the permissions necessary for users and AWS services.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h3>
<ul>
<li>
<p><a href="https://aws.amazon.com/es/premiumsupport/knowledge-center/secrets-manager-share-between-accounts/" target="_blank" rel="noopener noreferrer">AWS documentation 1</a></p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html" target="_blank" rel="noopener noreferrer">AWS documentation 2</a></p>
</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="Content related with AWS" class="tag_zVej tagRegular_sFm0" href="/blog/tags/aws">AWS</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2021-02-15-sharing-secrets-AWS-multi-account architecture.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/terraform-compliance"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Trusting in your IaC Terraform Compliance</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#terraform-code" class="table-of-contents__link toc-highlight">Terraform Code</a></li><li><a href="#steps" class="table-of-contents__link toc-highlight">Steps</a><ul><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Daniel Rivera, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>