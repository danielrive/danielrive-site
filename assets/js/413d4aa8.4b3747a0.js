"use strict";(self.webpackChunkdanielrive_site=self.webpackChunkdanielrive_site||[]).push([[9105],{8248:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>l,frontMatter:()=>o,metadata:()=>r,toc:()=>h});var s=n(4848),a=n(8453);const o={slug:"Event-Bridge-Lambda",title:"AWS Event-Bridge and Lambda to copy RDS snapshots to another Region",authors:["danielrivera"],tags:["aws"]},i=void 0,r={permalink:"/blog/Event-Bridge-Lambda",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-03-02-Event-Bridge-Lambda-copy-RDS-snapshots.md",source:"@site/blog/2022-03-02-Event-Bridge-Lambda-copy-RDS-snapshots.md",title:"AWS Event-Bridge and Lambda to copy RDS snapshots to another Region",description:"Architecture Diagram",date:"2022-03-02T00:00:00.000Z",tags:[{inline:!1,label:"AWS",permalink:"/blog/tags/aws",description:"Content related with AWS"}],readingTime:3.67,hasTruncateMarker:!0,authors:[{name:"Daniel German Rivera",title:"Cloud Engineer",url:"https://github.com/danielrive",page:{permalink:"/blog/authors/danielrivera"},socials:{github:"https://github.com/danielrive",linkedin:"https://www.linkedin.com/in/danielrive/"},key:"danielrivera"}],frontMatter:{slug:"Event-Bridge-Lambda",title:"AWS Event-Bridge and Lambda to copy RDS snapshots to another Region",authors:["danielrivera"],tags:["aws"]},unlisted:!1,prevItem:{title:"Enabling logs and alerting in AWS EKS cluster - CloudWatch and fluent-bit",permalink:"/blog/fluentbit-cloudwatch"},nextItem:{title:"Trusting in your IaC Terraform Compliance",permalink:"/blog/terraform-compliance"}},c={authorsImageUrls:[void 0]},h=[{value:"RDS Snapshot",id:"rds-snapshot",level:2},{value:"AWS Event-Bridge",id:"aws-event-bridge",level:2},{value:"How to use the events?",id:"how-to-use-the-events",level:3},{value:"Lambda Function",id:"lambda-function",level:2}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6rjyhs8hmbwc76fkztos.png",alt:"Architecture Diagram"})}),"\n",(0,s.jsxs)(t.p,{children:["A few months ago I was asked to design the DRP process(Multi-Region) for a project that used RDS(PostgreSQL). RDS instances were critical components, these stored PII information. RDS automatically takes snapshots of the instances and you can use them to recreate the instances in case of failure, these snapshots just can be used in the same region but you can share or copy them between accounts and Regions, here some ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html",children:"AWS Docs related RDS automatic snapshots"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"My initial idea was to create a K8 job to run pg_dump for each RDS instance and then, upload the file to an S3 bucket created in a different region, not too bad but this requires more work to backup and restore. so I decided to copy snapshots between regions, a new challenge appeared here, how to automate that copy? In this post I will show the approach that I follow to solve this, one crucial point to mention here is that for a big number of snapshots, this solution could not be the best due to some limitations that AWS RDS to copy snapshots."}),"\n",(0,s.jsx)(t.p,{children:"AWS Documentation says:"}),"\n",(0,s.jsx)(t.blockquote,{children:"\n"}),"\n",(0,s.jsx)(t.p,{children:'"You can have up to 20 snapshot copy requests in progress to a single destination Region per account."'}),"\n",(0,s.jsx)(t.p,{children:"This approach uses AWS event-bridge and Lambda to automate the copy process, at summary, even-bridge detects that a new RDS snapshot has been created and triggers a lambda function to copy the snapshot to the other region."}),"\n",(0,s.jsx)(t.blockquote,{children:"\n"}),"\n",(0,s.jsxs)(t.p,{children:["A terraform code was created for this pods and you can check it ",(0,s.jsx)(t.a,{href:"https://github.com/danielrive/blog-posts/blob/main/copy-rds-snapshots",children:"here"})]}),"\n",(0,s.jsx)(t.h2,{id:"rds-snapshot",children:"RDS Snapshot"}),"\n",(0,s.jsx)(t.p,{children:"You can configure automated RDS snapshots for your instance, this occurs daily during the backup window that you define in the instance creation.\nIn this case, the automated RDS snapshot was configured in each instance, this just creates the snapshot in the same account and region where the RDS instance was created."}),"\n",(0,s.jsx)(t.h2,{id:"aws-event-bridge",children:"AWS Event-Bridge"}),"\n",(0,s.jsx)(t.p,{children:"EventBridge is a serverless service that uses events to connect application components together, making it easier for you to build scalable event-driven applications. You can use it to route events from sources such as home-grown applications, AWS services, and third-party software to consumer applications across your organization."}),"\n",(0,s.jsxs)(t.p,{children:["In this case, AWS generates a significant number of events for some services, for RDS you can find the events divided into categories, the following table shows the events for RDS snapshots. when RDS starts an automated snapshot, AWS registers that event. You can find all the events in the ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Events.Messages.html",children:"AWS documentation"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/beogf5s4wdgk7wfbb5c3.png",alt:"RDS Events"})}),"\n",(0,s.jsx)(t.h3,{id:"how-to-use-the-events",children:"How to use the events?"}),"\n",(0,s.jsx)(t.p,{children:"Let's start with an important concept in the EventBridge world, An event bus. This a pipeline that receives events, you can configure rules to manipulate the events and specify actions when these came. Events are represented as JSON objects and they all have a similar structure and the same top-level fields. By default, the AWS accounts have a default event bus that receives events from AWS services."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g2qv8j574deuvsbwz4rb.png",alt:"default event-bus"})}),"\n",(0,s.jsx)(t.p,{children:"In this case, we can create a rule using the default event-bus."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mmi4m21fibnoe4anq2k5.png",alt:"rds-rule-creation"})}),"\n",(0,s.jsx)(t.p,{children:"You can choose the AWS service to use and AWS will show you and JSON with an example of how the event will look."}),"\n",(0,s.jsx)(t.p,{children:"For our case we can use a simpler event using the EventID for automated snapshots, RDS-EVENT-0091, you can refer to the image shown at the top of the post for more information."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "source": ["aws.rds"],\n  "detail-type": ["RDS DB Snapshot Event"],\n  "account": ["1234567890"],\n  "region": ["us-east-1"],\n  "detail": {\n     "SourceType": ["SNAPSHOT"],\n      "EventID": ["RDS-EVENT-0091"]   \n    }\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"With the event-pattern defined, we can specify the lambda function to execute when this event comes to the default event bus."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0l40u9o0ai1k7xehswu8.png",alt:"Trigger-lambda"})}),"\n",(0,s.jsx)(t.p,{children:"This means that if an event is received in the default event bus and matches with the pattern specified, that will trigger the lambda and pass a JSON with the event generated, this looks like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "version": "0",\n  "id": "844e2571-85d4-695f-b930-0153b71dcb42",\n  "detail-type": "RDS DB Snapshot Event",\n  "source": "aws.rds",\n  "account": "123456789012",\n  "time": "2018-10-06T12:26:13Z",\n  "region": "us-east-1",\n  "resources": ["arn:aws:rds:us-east-1:123456789012:db:mysql-instance-2018-10-06-12-24"],\n  "detail": {\n    "EventCategories": ["creation"],\n    "SourceType": "SNAPSHOT",\n    "SourceArn": "arn:aws:rds:us-east-1:123456789012:db:mysql-instance-2018-10-06-12-24",\n    "Date": "2018-10-06T12:26:13.882Z",\n    "SourceIdentifier": "rds:mysql-instance-2018-10-06-12-24",\n    "Message": "Automated snapshot created"\n  }\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"lambda-function",children:"Lambda Function"}),"\n",(0,s.jsx)(t.p,{children:"The lambda function is a python code that gets the events and extracts the useful information and starts a copy in another region."}),"\n",(0,s.jsx)(t.p,{children:"The lambda functions just start the copy, the function doesn't wait to be completed the task."}),"\n",(0,s.jsxs)(t.p,{children:["You can see the python code ",(0,s.jsx)(t.a,{href:"https://github.com/danielrive/blog-posts/blob/main/copy-rds-snapshots/modules/python_code/copy-snapshots.py",children:"here"})]})]})}function l(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>r});var s=n(6540);const a={},o=s.createContext(a);function i(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);