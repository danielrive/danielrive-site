"use strict";(self.webpackChunkdanielrive_site=self.webpackChunkdanielrive_site||[]).push([[6329],{2772:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var t=s(4848),a=s(8453);const r={slug:"EKS-Prometheus",title:"Adding monitoring to EKS using Prometheus operator",authors:["danielrivera"],tags:["aws","SmartCash-Project","kubernetes"]},o=void 0,i={permalink:"/blog/EKS-Prometheus",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2023-11-30-Adding-monitoring-to-EKS-using-Prometheus-operator.md",source:"@site/blog/2023-11-30-Adding-monitoring-to-EKS-using-Prometheus-operator.md",title:"Adding monitoring to EKS using Prometheus operator",description:"eks+prometheus+grafana",date:"2023-11-30T00:00:00.000Z",tags:[{inline:!1,label:"AWS",permalink:"/blog/tags/aws",description:"Content related with AWS"},{inline:!0,label:"SmartCash-Project",permalink:"/blog/tags/smart-cash-project"},{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes",description:"Content related with Kubernetes"}],readingTime:5.375,hasTruncateMarker:!0,authors:[{name:"Daniel German Rivera",title:"Cloud Engineer",url:"https://github.com/danielrive",page:{permalink:"/blog/authors/danielrivera"},socials:{github:"https://github.com/danielrive",linkedin:"https://www.linkedin.com/in/danielrive/"},key:"danielrivera"}],frontMatter:{slug:"EKS-Prometheus",title:"Adding monitoring to EKS using Prometheus operator",authors:["danielrivera"],tags:["aws","SmartCash-Project","kubernetes"]},unlisted:!1,prevItem:{title:"Using Terraform to push files to Git Repo for GitOps",permalink:"/blog/terraform-gitops"},nextItem:{title:"GitOps with FluxCD",permalink:"/blog/fluxcd"}},l={authorsImageUrls:[void 0]},c=[{value:"Source Code",id:"source-code",level:2},{value:"Prometheus operator",id:"prometheus-operator",level:2},{value:"Prometheus Operator, kube-prometheus and kube-prometheus-stack",id:"prometheus-operator-kube-prometheus-and-kube-prometheus-stack",level:3},{value:"Installing kube-prometheus-stack Helm chart",id:"installing-kube-prometheus-stack-helm-chart",level:2},{value:"Grafana Dashboards",id:"grafana-dashboards",level:3},{value:"Creating nginx ingress for Grafana",id:"creating-nginx-ingress-for-grafana",level:4},{value:"Installing Cert-managet to support SSL",id:"installing-cert-managet-to-support-ssl",level:4}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/404iotfmmlhlrsm8swt7.png",alt:"eks+prometheus+grafana"})}),"\n",(0,t.jsxs)(n.p,{children:["Previous articles showed how to ",(0,t.jsx)(n.a,{href:"https://dev.to/aws-builders/smartcash-project-infrastructure-terraform-and-github-actions-2bo3",children:"build the EKS Infrastructure in AWS"})," and ",(0,t.jsx)(n.a,{href:"https://dev.to/aws-builders/smartcash-project-gitops-with-fluxcd-3aep",children:"how to install FluxCD"})," to implement GitOps practices, This article is focused on explaining the steps taken to install the Prometheus Operator(using Helm) and Grafana for monitoring."]}),"\n",(0,t.jsx)(n.h2,{id:"source-code",children:"Source Code"}),"\n",(0,t.jsxs)(n.p,{children:["The source code for this project can be found ",(0,t.jsx)(n.a,{href:"https://github.com/danielrive/smart-cash/releases/tag/v1.3.0",children:"here"}),", also a ",(0,t.jsx)(n.a,{href:"https://github.com/danielrive/smart-cash-gitops-flux",children:"GitOps repository"})," has been created to store the Yaml files that FluxCD uses and apply to the EKS cluster."]}),"\n",(0,t.jsx)(n.h2,{id:"prometheus-operator",children:"Prometheus operator"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"The Prometheus Operator provides Kubernetes native deployment and management of Prometheus and related monitoring components."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.a,{href:"https://prometheus-operator.dev/docs/operator/design/",children:"Prometheus operator"})," defines Kubernetes Custom Resources and controllers that facilitate installing Prometheus. The community has developed alternative options such as ",(0,t.jsx)(n.em,{children:"kube-Prometheus"})," and ",(0,t.jsx)(n.em,{children:"kube-prometheus-stack"})," to install the components to monitor Kubernetes."]}),"\n",(0,t.jsx)(n.h3,{id:"prometheus-operator-kube-prometheus-and-kube-prometheus-stack",children:"Prometheus Operator, kube-prometheus and kube-prometheus-stack"}),"\n",(0,t.jsxs)(n.p,{children:["The project repository for Prometheus-operator can be found ",(0,t.jsx)(n.a,{href:"https://github.com/prometheus-operator/prometheus-operator",children:"here"}),", The repo defines the CRDs and the controller. You can follow this ",(0,t.jsx)(n.a,{href:"https://prometheus-operator.dev/docs/user-guides/getting-started/",children:"documentation"})," for the installation. which will require the creation of metrics exporters, node exporters, scrape configurations, etc."]}),"\n",(0,t.jsxs)(n.p,{children:["On the other hand, the ",(0,t.jsx)(n.a,{href:"https://github.com/prometheus-operator/kube-prometheus",children:"Kube-prometheus"})," project provides documentation and scripts to operate end-to-end Kubernetes cluster monitoring using the Prometheus Operator, making easier the process of monitoring the Kubernetes cluster."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://github.com/prometheus-community/helm-charts",children:"kube-prometheus-stack"})," is a Helm chart that contains several components to monitor the Kubernetes cluster, along with Grafana dashboards to visualize the data. This option will be used in this article."]}),"\n",(0,t.jsx)(n.h2,{id:"installing-kube-prometheus-stack-helm-chart",children:"Installing kube-prometheus-stack Helm chart"}),"\n",(0,t.jsx)(n.p,{children:"In previous articles, FluxCD was installed in EKS cluster to implement GitOps, the following flux source will now be added."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-YAML",children:"apiVersion: source.toolkit.fluxcd.io/v1beta2\nkind: HelmRepository\nmetadata:\n  name: helm-repo-prometheus\n  namespace: flux-system\nspec:\n  interval: 10m0s\n  url: https://prometheus-community.github.io/helm-charts\n"})}),"\n",(0,t.jsx)(n.p,{children:"Also, a Flux Helm release is added"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-YAML",children:'apiVersion: helm.toolkit.fluxcd.io/v2beta1\nkind: HelmRelease\nmetadata:\n  name: prometheus\n  namespace: monitoring\nspec:\n  interval: 10m0s\n  chart:\n    spec:\n      chart: kube-prometheus-stack\n      sourceRef:\n        kind: HelmRepository\n        name: helm-repo-prometheus\n        namespace: flux-system\n  values:\n    defaultRules:\n      rules:\n        etcd: false\n        kubeSchedulerAlerting: false\n        kubeSchedulerRecording: false\n        windows: false\n    prometheus:\n      prometheusSpec:\n        storageSpec:\n            volumeClaimTemplate:\n              spec:\n                storageClassName: aws-ebs-gp2\n                accessModes: ["ReadWriteOnce"]\n                resources:\n                  requests:\n                    storage: 40Gi\n'})}),"\n",(0,t.jsx)(n.p,{children:"If you examine the values for the chart, by default, it installs rules to monitor etcd and some other control plane components. However, in this case, that is not necessary due to EKS limiting access to certain control-plane components."}),"\n",(0,t.jsxs)(n.p,{children:["By default, Prometheus uses local storage to store data. To enable persistent storage, an EBS volume can be added. In this scenario, the ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html",children:"EBS CSI"})," driver is employed, and a storage class is defined to manage the integration with Prometheus."]}),"\n",(0,t.jsxs)(n.p,{children:["Once the manifests are ready, you can push them to the GitOps repo( ",(0,t.jsx)(n.a,{href:"https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/helm-prometheus.yaml",children:"here"})," for this case), and wait for Flux to handle the installation process in the cluster."]}),"\n",(0,t.jsxs)(n.p,{children:["You can check the cluster by looking for the resources created, notice that for this case, everything will be placed in the ",(0,t.jsx)(n.strong,{children:"monitoring"})," namespace."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl get crd"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qfjv7qgaitj5a0pmmsfc.png",alt:"prometheus-cdr"})}),"\n",(0,t.jsx)(n.p,{children:"Additionally, certain deployments and services should have been created in the monitoring namespace."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl get pods -n monitoring"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6suj0e8ez0kf3jkn3vde.png",alt:"pods"})}),"\n",(0,t.jsx)(n.p,{children:"Let's look at the Prometheus server console, you can expose the service by an ingress or using port-forward."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl port-forward service/prometheus-kube-prometheus-prometheus 3001:9090 -n monitoring"})}),"\n",(0,t.jsx)(n.p,{children:"The previous command will expose the Prometheus service in localhost:3001, you can go directly to the targets and you should see some targets created automatically, as well as the metrics and the services discovered by the server."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z0a5ff0d9w9es56q4gtu.png",alt:"targets"})}),"\n",(0,t.jsx)(n.p,{children:"This is useful because you don't need to configure the targets to monitor K8 and node metrics, the Helm chart does this for you. For instance, a simple example is just to check the number of pods created in the default namespace, you can run this PromQL query."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:'count(kube_pod_created{namespace="default"})'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dwt7ryjpjyay53x2q9r7.png",alt:"simple-query"})}),"\n",(0,t.jsx)(n.h3,{id:"grafana-dashboards",children:"Grafana Dashboards"}),"\n",(0,t.jsx)(n.p,{children:"Helm chart also installs Grafana and configures some useful dashboards that you can use, if you list the services and pods you will see some resources related to Grafana. You can expose the Grafana service or create an ingress for it."}),"\n",(0,t.jsx)(n.h4,{id:"creating-nginx-ingress-for-grafana",children:"Creating nginx ingress for Grafana"}),"\n",(0,t.jsxs)(n.p,{children:["Nginx-ingress is utilized and installed using Helm. You can add the following Flux source and the Helm release to the GitOps repo. Check the GitOps repo for this project ",(0,t.jsx)(n.a,{href:"https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/helm-nginx-ingress.yaml",children:"here"})," and use it as a model."]}),"\n",(0,t.jsx)(n.p,{children:"Helm source"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: source.toolkit.fluxcd.io/v1beta2\nkind: HelmRepository\nmetadata:\n  name: helm-repo-nginx-ingress\n  namespace: flux-system\nspec:\n  interval: 10m0s\n  type: oci\n  url: oci://ghcr.io/nginxinc/charts\n"})}),"\n",(0,t.jsx)(n.p,{children:"Use this yaml to install the chart, in this case AWS Network Load Balancer is used, this is done through the annotation specified in the values for the chart."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-Yaml",children:'apiVersion: helm.toolkit.fluxcd.io/v2beta1\nkind: HelmRelease\nmetadata:\n  name: nginx-ingress\n  namespace: nginx-ingress\nspec:\n  interval: 10m0s\n  chart:\n    spec:\n      chart: nginx-ingress\n      version: 1.0.2\n      sourceRef:\n        kind: HelmRepository\n        name: helm-repo-nginx-ingress\n        namespace: flux-system\n  values:\n    controller:\n      service:\n        annotations: \n          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"\n'})}),"\n",(0,t.jsx)(n.h4,{id:"installing-cert-managet-to-support-ssl",children:"Installing Cert-managet to support SSL"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"This article will not dig into details about cert-manager concepts."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"In order to support SSL in the EKS cluster cert-manager will be used, cert-manager adds certificates and certificate issuers as resource types in Kubernetes clusters, and simplifies the process of obtaining, renewing and using those certificates."}),"\n",(0,t.jsx)(n.p,{children:"Cert-manager uses Kubernetes CRD, to install them you can run:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.crds.yaml"})}),"\n",(0,t.jsxs)(n.p,{children:["This also can be added to the GitOps repo(check ",(0,t.jsx)(n.a,{href:"https://github.com/danielrive/smart-cash-gitops-flux/blob/main/common/crd-cert-manager.yaml",children:"here"}),") and given to Flux to handle it."]}),"\n",(0,t.jsx)(n.p,{children:"When the CRDs are ready, you can install cert-manager, in this case a Helm chart will be used, this also will be added in GitOps repo."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-YAML",children:"apiVersion: helm.toolkit.fluxcd.io/v2beta1\nkind: HelmRelease\nmetadata:\n  name: cert-manager\n  namespace: cert-manager\nspec:\n  interval: 10m0s\n  chart:\n    spec:\n      chart: cert-manager\n      version: 1.13.2\n      sourceRef:\n        kind: HelmRepository\n        name: helm-cert-manager\n        namespace: flux-system\n  values:\n    serviceAccount:\n      annotations:\n        eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/cert-manager-us-west-2\n    securityContext:\n      fsGroup: 1001\n    extraArgs:\n      - --issuer-ambient-credentials\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"Finally and cert-manager ClusterIssuer is added, in this case the domain will be validated in AWS Route53, this is done through the IAM role passed in the previous YAML file for the Helm chart."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-YAML",children:'apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: example-letsencrypt2\nspec:\n  acme:\n    email: notreply@example.info\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: example-issuer-account-key\n    solvers:\n    - selector:\n        dnsZones:\n          - "example.info"\n      dns01:\n        route53:\n          region: us-west-2\n'})}),"\n",(0,t.jsx)(n.p,{children:"Once cert-manager and nginx-ingress are installed you can create an ingress for Grafana. The following manifest has been added to the GitOps repo."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-YAML",children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: grafana-ingress\n  namespace: monitoring\n  annotations:\n    cert-manager.io/cluster-issuer: example-letsencrypt2\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: monitoring.example.info\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: prometheus-grafana\n            port:\n              number: 80\n  tls:\n   - hosts:\n     - monitoring.example.info\n     secretName: example-issuer-account-ingress-key2\n"})}),"\n",(0,t.jsx)(n.p,{children:"With this installed you can browser and access Grafana, you should see some dashboards already created."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/cxhfnhv82jfuk3b1kj8t.png",alt:"Grafana-dash"})}),"\n",(0,t.jsxs)(n.p,{children:["For instance, the ",(0,t.jsx)(n.em,{children:"Kubernetes/API server"})," dashboard is pre-configured, also you can also use third-party dashboards."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7zilyb7s756tkm696r4g.png",alt:"Grafana-k8-api"})})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>i});var t=s(6540);const a={},r=t.createContext(a);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);